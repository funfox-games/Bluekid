import{onAuthStateChanged,auth,db,doc,getDoc,setDoc,GoogleAuthProvider,signInWithPopup,signInWithEmailAndPassword,sendPasswordResetEmail,signOut}from"../../js/util/firebase.js";let urlParams=new URLSearchParams(location.search);import{returnDefaultCreateData}from"./createdata.js";var loggedin=!1;document.getElementById("login").addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("email").value,t=document.getElementById("password").value,e=(document.getElementById("loginbutton").setAttribute("disabled",""),document.getElementById("loginbutton").innerHTML="Logging in...",await signInWithEmailAndPassword(auth,e,t).catch(e=>{var t=e.code;return console.error("("+t+") LOG IN ERROR: "+e.message),"auth/user-not-found"==t?showNotification(3,"User email doesn't exist. <a href='#'>Need signed up?</a>"):"auth/wrong-password"==t?showNotification(3,"Wrong password."):showNotification(3,"Something went wrong. Check the console for more details."),document.getElementById("loginbutton").removeAttribute("disabled"),document.getElementById("loginbutton").innerHTML='<i class="fa-light fa-door-open"></i> Log in',null}));null!=e&&(location.href="../profile/index.html")}),document.getElementById("google").addEventListener("click",async()=>{var e,t=new GoogleAuthProvider,t=(auth.useDeviceLanguage(),await signInWithPopup(auth,t).catch(e=>{var t=e.code,e=e.message;return"auth/popup-closed-by-user"==t?showNotification(3,"Prompt canceled."):showNotification(3,"Something went wrong."),console.log(t,e),null}));null!=t&&(GoogleAuthProvider.credentialFromResult(t).accessToken,t=t.user,0==(await getDoc(doc(db,"users",t.uid))).exists())&&(e=returnDefaultCreateData(),await setDoc(doc(db,"users",t.uid),e).catch(e=>{console.error(e),rej(e)}))}),onAuthStateChanged(auth,async e=>{if(e){if(e.isAnonymous)return await signOut(auth),void location.reload();document.getElementById("loginbutton").setAttribute("disabled",""),document.getElementById("loginbutton").innerHTML="Logged in",document.getElementById("google").innerHTML='<img src="../asset/google.webp" alt="googleLogo" width="22"> Merge with Google';e=urlParams.get("redirect");null!=e&&(location.href=decodeURIComponent(e)),document.getElementById("loggedin").setAttribute("show","")}document.getElementById("forgotpassword").addEventListener("click",()=>{document.getElementById("forget_pass").showModal()}),document.getElementById("sendpasswordemail").addEventListener("click",async()=>{document.getElementById("sendpasswordemail").innerHTML="Waiting...",document.getElementById("sendpasswordemail").setAttribute("disabled","");var e=document.getElementById("resetPasswordEmail").value;"YESSIR"!=await sendPasswordResetEmail(auth,e).catch(e=>(console.error(e.code),"auth/invalid-email"==e.code&&(document.getElementById("sendpasswordemail").innerHTML="Not vaild user.",document.getElementById("sendpasswordemail").removeAttribute("disabled")),"auth/missing-email"==e.code&&(document.getElementById("sendpasswordemail").innerHTML="Email needed.",document.getElementById("sendpasswordemail").removeAttribute("disabled")),"YESSIR"))&&(document.getElementById("sendpasswordemail").innerHTML="Success!",document.getElementById("sendpasswordemail").removeAttribute("disabled"))})});