import{auth,db,onAuthStateChanged,doc,getDoc,updateDoc,getDocs,collection,deleteDoc,addDoc,setDoc}from"../../js/util/firebase.js";import{getRedirectUrl}from"../../js/util/redirectUrl.js";async function start(){var s=e=>{document.getElementById("progression").innerHTML=e},e=(document.getElementById("close").setAttribute("disabled","true"),document.getElementById("convert_btn").setAttribute("disabled","true"),document.getElementById("transfer__info").style.display="none",document.getElementById("transfer__progression").style.display="block",doc(db,"users",auth.currentUser.uid)),t=await getDoc(e).then(e=>e.data()),o=await getDocs(collection(db,"users",auth.currentUser.uid,"blues")),n=await getDocs(collection(db,"users",auth.currentUser.uid,"kits")),r=(e,t)=>{if(e=parseFloat(e),0<(t=t?parseInt(t,10):0)){var n=t;t="1";for(let e=0;e<n;e++)t+="0",t=parseInt(t,10)}else t=1;return Math.round((e+Number.EPSILON)*+t)/+t};s("Removing unnecessary profile properties..."),delete t.email,delete t.accounttype,delete t.rank,console.log(t),await setDoc(e,t),s("Fixing blues..."),console.log(o);for(let n=0;n<o.docs.length;n++){let e=o.docs[n];var d=r((n+1)/o.size*100,2);let t=e.data();e.id;s("Fixing blues... ("+d+"%)"),t.chance&&delete t.chance,t.rarity&&delete t.rarity,null!=(t=!t.pack&&document.getElementById("deleteBuggedBlues").checked?null:t)?await updateDoc(e.ref,t):await deleteDoc(e.ref)}s("Fixing kits...");for(let t=0;t<n.docs.length;t++){let e=n.docs[t];var l=r((t+1)/n.size*100,2),i=e.data(),l=(e.id,s("Fixing kits... ("+l+"%)"),i.QLength&&delete i.QLength,i.author=auth.currentUser.uid,i.canclone||(i.canclone=!1),i.cover||(i.cover="https://bluekid.netlify.app/asset/templates/kit_temp.png"),i.visibility||(i.visibility="private"),i.questions);if(l.constructor!=Array){var a=Object.entries(l),c=[];for(let e=0;e<a.length;e++){var u=a[e][1];u.a1=u[1],u.a2=u[2],u.a3=u[3],u.a4=u[4],delete u[1],delete u[2],delete u[3],delete u[4],c.push(u)}i.questions=c}await addDoc(collection(db,"users",auth.currentUser.uid,"kits"),i),await deleteDoc(e.ref)}s("Finishing up..."),t.communitySettings||(t.communitySettings={allowFriendRequests:!0,privacy:{hideTokens:!1,showBlues:"friends",showGameHistory:"friends",showKits:"all",showLastOnline:"all",showStatus:"all"}}),t.favoriteKits||(t.favoriteKits=[]),t.friends||(t.friends=[]),t.requests||(t.requests=[]),t.sentRequests||(t.sentRequests=[]),t.version=2,t.tokens||(t.tokens=0),await setDoc(e,t),document.getElementById("close").removeAttribute("disabled"),document.getElementById("close").innerHTML='<i class="fa-solid fa-address-card"></i> Profile',document.getElementById("close").classList.add("primary"),document.getElementById("close").classList.remove("secondary"),document.getElementById("close").addEventListener("click",()=>{location.href="../profile/index.html"}),document.getElementById("donotrefresh").remove(),document.getElementById("progression").remove(),document.getElementById("convert_btn").remove(),document.getElementById("transferinprogress").innerHTML='<i class="fa-solid fa-check"></i> Transfer completed!'}onAuthStateChanged(auth,async e=>{e?(e=doc(db,"users",e.uid),null!=(e=await getDoc(e).then(e=>e.data())).version&&2==e.version&&(document.getElementById("already").style.display="unset",document.getElementById("transfer").style.display="none"),document.getElementById("convert_btn").addEventListener("click",start)):(document.getElementById("login_a").href="login.html?redirect="+getRedirectUrl(),document.getElementById("transfer").style.display="none",document.getElementById("login").style.display="unset")}),document.getElementById("upgrade").addEventListener("click",()=>{document.getElementById("transfere").showModal()});