<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My profile - Bluekid</title>

    <link rel="icon" type="image/png" href="./assets/Bluekid.png">
</head>
<body>
    <button onclick="window.location.href='./index.html'">Go to home page</button>
    <button onclick="window.history.back()">Go back</button>
    <hr>
    <h1 id="name">Please wait...</h1>
    <p id="creation-date">Please wait...</p>
    <button onclick="creategame()">Create test game</button>
    <h2>Settings</h2>
    <div id="profile" style="display: none;">
        <hr>
        <input id="newname" placeholder="Enter new name...">
        <input id="confirmnewname" placeholder="Confirm new name...">
        <button id="changename" onclick="changename()">Change name</button>
        <p id="result_text"></p>
        <hr>
        <button onclick="logout()">Log out</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      // NOTE - INCLUDE YOUR FIREBASE CONFIG HERE FOR ANYTHING TO WORK:
      const firebaseConfig = {
        apiKey: "AIzaSyDB3PJ-cXM9thcOYhajlz15b8LiirZ44Kk",
        authDomain: "bluekid-303db.firebaseapp.com",
        databaseURL: "https://bluekid-303db-default-rtdb.firebaseio.com",
        projectId: "bluekid-303db",
        storageBucket: "bluekid-303db.appspot.com",
        messagingSenderId: "207140973406",
        appId: "1:207140973406:web:888dcf699a0e7d1e30fdcf"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
    <script>
        let loggedinuser;
        let username;

        const email = localStorage.getItem("email");
        const password = localStorage.getItem("pass");

        firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // signed in
            var user = userCredential.user;
            console.log("signed in password: " + user.uid)
            loggedinuser = user;

            const playerData = firebase.firestore().collection("users").doc(user.uid);
            playerData.get().then((doc) => {
                username = doc.data().username;

                document.getElementById("name").innerHTML = "Hello, " + doc.data().username + "!";
                document.getElementById("creation-date").innerHTML = "User since: " + doc.data().creation;

                document.getElementById("profile").style.display = "";
            })
        })
        .catch((error) => {
            console.log(error.message)

            document.getElementById("name").innerHTML = "Error: " + error.message;
        });

        function changename() {
            const newname = document.getElementById("newname").value;
            const confirm = document.getElementById("confirmnewname").value;
            let output = document.getElementById("result_text");

            if (newname != confirm) {
                output.innerHTML = "The usernames entered dont match."
                return;
            }
            if (newname == "") {
                output.innerHTML = "Your new name cant be blank!"
                return;
            }

            let playerData = firebase.firestore().collection("users").doc(loggedinuser.uid);
            playerData.update({
                username: newname
            }).then((doc) => {
                output.innerHTML = "Username has been switched to " + newname + "!"
                //window.location.reload();
            })
        }

        function creategame() {
            window.location.href = "./game.html?id="+Math.floor(Math.random()*100000)+"&name="+username;
        }

        function logout() {
            localStorage.setItem("isLoggedIn", "false");
            firebase.auth().signOut();
            console.log("logged out:logoutfunction");
            alert("You have been logged out.");
            window.location.href = "./auth_pages/login.html";
        }
    </script>
</body>
</html>