<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blues - Bluekid</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="../assets/Bluekid.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito&display=swap');

        * {
            font-family: 'Nunito', sans-serif;
        }

        ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 12.5%;
            background-color: #98deff;
            outline: 2px solid black;
            border-radius: 5px;
            position: fixed;
            height: 98%;
            overflow: auto;
            text-align: center;
            justify-content: center;
        }
        ul li {
            padding-bottom: 10px;
        }
        li a { /* List element */
            display: block;
            color: #000;
            padding: 4px 8px;
            text-decoration: none;
            font-size: 3vh;
            display: inline-flex;
        }

        #imgtitle {
            display: none;
        }

        @media screen and (max-width: 1000px) {
            #imgtitle {
                padding-top: 10px;
                display: inline;
            }

            #title {
                display: none;
            }
        }

        li a img {
            padding-right: 10px;
        }

        @media screen and (max-width: 800px) {
            li a {
                font-size: 0;
            }

            li a img {
                padding-right: 0px;
            }
            
        }

        .property {
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        .property > span {
            font-weight: normal;
            font-style: italic;
        }

        #changeAccountType {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #0000009c;
        }

        .window {
            background-color: #fff;
            position: absolute;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #000;
            text-align: center;

            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .window h1 {
            margin: 0;
        }
        .window h2 {
            margin: 0;
        }
        .window h3 {
            margin: 0;
        }
        .window p {
            margin: 0;
        }

        .option {
            display: flex;
            gap: 10px;
        }

        .option.innerdiv {
            flex-direction: column;
        }

        .option p a {
            color: black;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Side nav -->
    <ul>
        <a href="./index.html"><img id="imgtitle" src="../assets/Bluekid.png" width="50"></a>
        <a id="title" style="text-decoration: none; font-family: 'Titan One', cursive; margin: 0%; margin-top:5px; font-size:4vh; color: turquoise; -webkit-text-stroke-color: black; -webkit-text-stroke-width: 2px;" href="./index.html">Bluekid</a>
        <hr>
        <!-- UL means unordered list -->
        <!-- LI means list item -->

        <li> <a href="../profile.html"> <img src="../assets/user-solid.svg" draggable="false" width="30"> Profile </a> </li>
        <li> <a href="./blues.html"> <img src="../assets/briefcase-solid.svg" draggable="false" width="30"> Blues</a> </li>
        <li> <a href="./buy.html"> <img src="../assets/cart.svg" draggable="false" width="30"> Buy</a> </li>
        <li> <a href="./kits.html"> <img src="../assets/set.svg" draggable="false" width="30"> Kits</a> </li>
        <li> <a style="opacity: 0.5; cursor: default;" href="#"> <img src="../assets/settings.svg" draggable="false" width="30"> Settings</a> </li>
        <!-- <li><a>Favorites</a></li> -->
    </ul>

    <div id="changeAccountType" style="visibility:hidden;">
        <div class="window">
            <h1>Change Account Rank</h1>
            <p>An account type is a verification of time.<br>The more you are on Bluekid, the more you can rank up.</p>
            <hr>

            <div class="option">
                <button disabled="true" id="newbiebutton" onclick="setRank('Newbie')">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Newbie</h2>
                    <p>This is your starter pack for Bluekid!<br>This includes all the basic features you need! <a href="../docs/accountRanks.html#newbie">See all features</a></p>
                </div>
            </div>
            <br>
            <div class="option">
                <button disabled="true" id="intermbutton" onclick="setRank('Interm')">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Intermediate</h2>
                    <p>Hey, your getting used to this!<br>(Needs 4 months of experience to obtain) <a href="../docs/accountRanks.html#interm">See all features</a></p>
                </div>
            </div>
            <br>
            <div class="option">
                <button disabled="true" id="advancedbutton" onclick="setRank('Advanced')">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Advanced</h2>
                    <p>Not much to say is there?<br>(Needs a year of experience to obtain) <a href="../docs/accountRanks.html#advanced">See all features</a></p>
                </div>
            </div>
            <br>
            <p>Come back in <strong id="daysUntilNextRank">0</strong> days for the next rank!</p>
            <br>
            <button onclick="document.getElementById('changeAccountType').style.visibility = 'hidden'">Close</button>
        </div>
    </div>

    <div style="margin-left:12.5%;padding:1px 16px;">
        <p id="status">Loading data...</p>
        <div id="loaded" style="display: none;">
            <hr>
            <h1 id="data">Account data</h1>
            <p class="property">Username: <span id="username">Bluekid_User</span> <a style="font-size: 12.5px;" href="#newname">Change name</a></p>
            <p class="property">Email: <span id="email">example@example.org</span></p>
            <p class="property">Account type: <span id="type">Student</span></p>
            <p class="property">Joined: <span id="join">0/0/0000 0:00 PM</span></p>


            <h1 id="account">Account options</h1>
            <input id="newname" placeholder="Enter new name...">
            <input id="confirmnewname" placeholder="Confirm new name...">
            <button id="changename" onclick="changename()">Change name</button>
            <br> <br>
            <button onclick="document.getElementById('changeAccountType').style.visibility = 'visible'" id="rankbutton">Change Account Rank</button>
            <p id="result_text"></p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
      // NOTE - INCLUDE YOUR FIREBASE CONFIG HERE FOR ANYTHING TO WORK:
      const firebaseConfig = {
        apiKey: "AIzaSyDB3PJ-cXM9thcOYhajlz15b8LiirZ44Kk",
        authDomain: "bluekid-303db.firebaseapp.com",
        databaseURL: "https://bluekid-303db-default-rtdb.firebaseio.com",
        projectId: "bluekid-303db",
        storageBucket: "bluekid-303db.appspot.com",
        messagingSenderId: "207140973406",
        appId: "1:207140973406:web:888dcf699a0e7d1e30fdcf"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
    <script type="module">
        import data from "../banned.json" assert {"type": "json"};
        let loggedinuser;
        let username;

        const email = localStorage.getItem("email");
        const password = localStorage.getItem("pass");

        firebase.auth().onAuthStateChanged((user) => {
            // signed in
            console.log("signed in password: " + user.uid)
            loggedinuser = user;

            var hash = location.hash;
            if (hash) {
                hash = hash.replace("#", "");
                console.log(hash);
                var originalColor = document.getElementById(hash).style.backgroundColor;

                if (!document.getElementById(hash)) {return;}
                document.getElementById(hash).style.backgroundColor = "#008cff8f";
                document.getElementById(hash).style.transitionDuration = "3s";
                setTimeout(() => {
                    document.getElementById(hash).style.backgroundColor = originalColor;

                    setTimeout(() => {document.getElementById(hash).style.transitionDuration = "0s";}, 50);
                }, 1000);
            }

            const playerData = firebase.firestore().collection("users").doc(user.uid);
            playerData.get().then((doc) => {

                var time = (Date.parse(doc.data().creation) - new Date()); // milliseconds between now & user creation
                var accountCreationDifference = -Math.floor(time / 86400000); // days

                username = doc.data().username;

                document.getElementById("status").innerHTML = "Logged in as " + doc.data().username + ".";
                document.getElementById("loaded").style.display = "";

                var bannedEmails = data.bannedEmailaddresses
                for (var i = 0; i < data.bannedEmailaddresses.length; i++) {
                    if (bannedEmails[i].email == firebase.auth().currentUser.email) {
                        document.getElementById("status").innerHTML = "You have been banned. Reason: " + bannedEmails[i].reason;
                        document.getElementById("loaded").style.display = "none";
                    }
                }

                if (!doc.data().rank) {
                    console.log("no rank, creating rank...");

                    playerData.update({rank: "Newbie"}).then(() => {console.log("rank updated!")})
                } else {
                    console.log("rank found:", doc.data().rank)

                    const rank = doc.data().rank;

                    if (rank == "Newbie") {
                        document.getElementById("daysUntilNextRank").innerHTML = 121 - accountCreationDifference;

                        document.getElementById("newbiebutton").innerHTML = "Using";
                    } else {
                        if (accountCreationDifference >= 0) {
                            document.getElementById("newbiebutton").disabled = false;
                        }
                    }

                    if (rank == "Interm") {
                        document.getElementById("daysUntilNextRank").innerHTML = 365 - accountCreationDifference;

                        document.getElementById("intermbutton").innerHTML = "Using";
                    } else {
                        if (accountCreationDifference >= 121) {
                            document.getElementById("intermbutton").disabled = false;
                        }
                    }

                    if (rank == "Advanced") {
                        document.getElementById("daysUntilNextRank").parentElement.innerHTML = "Your maxed out!";

                        document.getElementById("advancedbutton").innerHTML = "Using";
                    } else {
                        if (accountCreationDifference >= 365) {
                            document.getElementById("advancedbutton").disabled = false;
                        }
                    }
                }

                if (accountCreationDifference >= 121) { // 4 MONTHS
                    document.getElementById("intermbutton").disabled = false;
                }

                if (accountCreationDifference >= 365) { // 1 YEAR
                    document.getElementById("advancedbutton").disabled = false;
                }

                const usernamedisplay = document.getElementById("username");
                const email = document.getElementById("email");
                const type = document.getElementById("type");
                const joindate = document.getElementById("join");

                usernamedisplay.innerHTML = username;
                email.innerHTML = doc.data().email;
                type.innerHTML = doc.data().accounttype;
                joindate.innerHTML = doc.data().creation;
            })
        });

        function setRank(rankType) {
            const playerData = firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid);

            playerData.update({rank: rankType}).then(() => {
                console.log("set new rank!");
            })
        }

        function changename() {
            const newname = document.getElementById("newname").value;
            const confirm = document.getElementById("confirmnewname").value;
            let output = document.getElementById("result_text");

            if (newname == username) {
                output.innerHTML = "Your new name cant be the same as your old name!"
                return;
            }
            if (newname != confirm) {
                output.innerHTML = "The usernames entered dont match."
                return;
            }
            if (newname == "") {
                output.innerHTML = "Your new name cant be blank!"
                return;
            }

            let playerData = firebase.firestore().collection("users").doc(loggedinuser.uid);
            playerData.update({
                username: newname
            }).then((doc) => {
                output.innerHTML = "Username has been switched to " + newname + "!"
                //window.location.reload();
            })
        }
    </script>
</body>
</html>