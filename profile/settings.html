<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blues - Bluekid</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titan+One&display=swap" rel="stylesheet">

    <link rel="icon" type="image/png" href="../assets/Bluekid.png">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito&display=swap');

        * {
            font-family: 'Nunito', sans-serif;
        }

        /*ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 12.5%;
            background-color: #98deff;
            outline: 2px solid black;
            border-radius: 5px;
            position: fixed;
            height: 98%;
            overflow: auto;
            text-align: center;
            justify-content: center;
        }
        ul li {
            padding-bottom: 10px;
        }
        li a {
            display: block;
            color: #000;
            padding: 4px 8px;
            text-decoration: none;
            font-size: 3vh;
            display: inline-flex;
        }*/

        #imgtitle {
            display: none;
        }

        @media screen and (max-width: 1000px) {
            #imgtitle {
                padding-top: 10px;
                display: inline;
            }

            #title {
                display: none;
            }
        }

        li a img {
            padding-right: 10px;
        }

        @media screen and (max-width: 800px) {
            li a {
                font-size: 0;
            }

            li a img {
                padding-right: 0px;
            }
            
        }

        .property {
            font-weight: bold;
            margin: 0;
            padding: 0;
        }

        .property > span {
            font-weight: normal;
            font-style: italic;
        }

        #changeAccountType {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: #0000009c;
        }

        .window {
            background-color: #fff;
            position: absolute;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #000;
            text-align: center;

            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        body {
            background-image: url("../assets/backgroundpattern.png");
            background-size: .75%;
            /* HALLOWOWWOWOWOWWOWOWOWWOWOWOWOWOWOWOWOWOWOWOWWOWOWOWOWOWOOWOWOWOWOWOWOWOOWWOWOWOOWWOWOWOWOWOWOOWWOOWOWOWOWOWOWOWOOWOWOWOWOWOEOEEEEEEEEEEEEEEEEEEEEEN */
            background-color: rgb(0,0,0);
            
        }

        .window h1 {
            margin: 0;
        }
        .window h2 {
            margin: 0;
        }
        .window h3 {
            margin: 0;
        }
        .window p {
            margin: 0;
        }

        .option {
            display: flex;
            gap: 10px;
        }

        .option.innerdiv {
            flex-direction: column;
        }

        .option p a {
            color: black;
            text-decoration: underline;
        }

        /* TOPNAV START */
        #topnav {
            display:flex;
            text-align: center;
            gap: 5px;
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 2px solid black;
            justify-content: center;
        }
        .topnav_item {
            display: flex;
            flex-direction: row;
            text-align: center;
            align-items: center;
            border-radius: 10px;
            gap:5px;
            padding: 5px;
            background-color: rgb(231, 231, 231);
            border: 2px solid black;
        }
        .topnav_item[data-navactive] {
            background-color: rgb(180, 180, 180);
        }
        .topnav_item a {
            color:black !important;
        }
        /*************************/
        #cnv {
            position:absolute;
            left:0;
            top:0;
            z-index: -9;
        }
        body{ color:white;}
        a {color:white!important;}
    </style>
</head>
<body>
    <canvas id="cnv"></canvas>

    <div id="topnav">
        <a href="index.html"><img src="../assets/Bluekid.png" width="44"></a>
        <div class="topnav_item" id="profile_topnav" >
            <img src="../assets/user-solid.svg" width="32">
            <a href="../profile.html">PROFILE</a>
        </div>
        <div class="topnav_item" id="blues_topnav">
            <img src="../assets/char/blue_notexture.png" width="32">
            <a href="./blues.html">BLUES</a>
        </div>
        <div class="topnav_item" id="buy_topnav">
            <img src="../assets/cart.svg" width="32">
            <a href="./buy.html">BUY</a>
        </div>
        <div class="topnav_item" id="kits_topnav">
            <img src="../assets/set.svg" width="32">
            <a href="./kits.html">KITS</a>
        </div>
        <div class="topnav_item" id="settings_topnav" data-navactive>
            <img src="../assets/settings.svg" width="32">
            <a href="./settings.html">SETTINGS</a>
        </div>
    </div>

    <div id="changeAccountType" style="visibility:hidden;">
        <div class="window">
            <h1>Change Account Rank</h1>
            <p>An account type is a verification of time.<br>The more you are on Bluekid, the more you can rank up.</p>
            <hr>

            <div class="option">
                <button disabled="true" id="newbiebutton">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Newbie</h2>
                    <p>This is your starter pack for Bluekid!<br>This includes all the basic features you need! <a href="../docs/accountRanks.html#newbie">See all features</a></p>
                </div>
            </div>
            <br>
            <div class="option">
                <button disabled="true" id="intermbutton">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Intermediate</h2>
                    <p>Hey, your getting used to this!<br>(Needs 4 months of experience to obtain) <a href="../docs/accountRanks.html#interm">See all features</a></p>
                </div>
            </div>
            <br>
            <div class="option">
                <button disabled="true" id="advancedbutton">Choose</button>
                <hr>
                <div class="option innerdiv">
                    <h2>Advanced</h2>
                    <p>Not much to say is there?<br>(Needs a year of experience to obtain) <a href="../docs/accountRanks.html#advanced">See all features</a></p>
                </div>
            </div>
            <br>
            <p>Come back in <strong id="daysUntilNextRank">0</strong> days for the next rank!</p>
            <br>
            <button onclick="document.getElementById('changeAccountType').style.visibility = 'hidden'">Close</button>
        </div>
    </div>

    <div style="padding:1px 16px;">
        <p id="status">Loading data...</p>
        <div id="loaded" style="display: none;">
            <hr>
            <h1 id="data">Account data</h1>
            <p class="property">Username: <span id="username">Bluekid_User</span> <a style="font-size: 12.5px;" href="#newname">Change name</a></p>
            <p class="property">Email: <span id="email">example@example.org</span></p>
            <p class="property">Account type: <span id="type">Student</span></p>
            <p class="property">Joined: <span id="join">0/0/0000 0:00 PM</span></p>
            <p class="property">Email verified: <span id="verified">false</span></p>
            <p class="property">UID: <span id="uid">waiting...</span></p>

            <h1>Resources</h1>
            <ul>
                <li> <a href="https://forms.gle/5rSzyNMfdTfnP9S68" style="color:black;">Verification/Content Creator Form</a> </li>
                <li> <p style="margin:0;">More coming soon!</p> </li>
            </ul>
            <h1 id="account">Account options</h1>
                <fieldset>
                    <legend>Change name</legend>
                    <input id="newname" placeholder="Enter new name...">
                    <input id="confirmnewname" placeholder="Confirm new name...">
                    <button id="changename">Change name</button>
                </fieldset>
                <br>
                <fieldset>
                    <legend>Change password</legend>
                    <button id="changepass">Send Email</button>
                </fieldset>
                <fieldset style="background-color:rgba(255,0,0,.1);">
                    <legend>DANGER ZONE</legend>
                    <button id="DELETE">Delete account</button>
                </fieldset>
            <br> <br>
            <button onclick="document.getElementById('changeAccountType').style.visibility = 'visible'" id="rankbutton">Change Account Rank</button>
            <p id="result_text"></p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../snow.js"></script>

    <script>
      // NOTE - INCLUDE YOUR FIREBASE CONFIG HERE FOR ANYTHING TO WORK:
      const firebaseConfig = {
        apiKey: "AIzaSyDB3PJ-cXM9thcOYhajlz15b8LiirZ44Kk",
        authDomain: "bluekid-303db.firebaseapp.com",
        databaseURL: "https://bluekid-303db-default-rtdb.firebaseio.com",
        projectId: "bluekid-303db",
        storageBucket: "bluekid-303db.appspot.com",
        messagingSenderId: "207140973406",
        appId: "1:207140973406:web:888dcf699a0e7d1e30fdcf"
      };
      firebase.initializeApp(firebaseConfig);
    </script>
    <script type="module">
        import data from "../banned.json" assert {"type": "json"};
        let loggedinuser;
        let username;

        const email = localStorage.getItem("email");
        const password = localStorage.getItem("pass");

        firebase.auth().onAuthStateChanged((user) => {
            // signed in
            console.log("signed in password: " + user.uid)
            loggedinuser = user;

            var hash = location.hash;
            if (hash) {
                hash = hash.replace("#", "");
                console.log(hash);
                var originalColor = document.getElementById(hash).style.backgroundColor;

                if (!document.getElementById(hash)) {return;}
                document.getElementById(hash).style.backgroundColor = "#008cff8f";
                document.getElementById(hash).style.transitionDuration = "3s";
                setTimeout(() => {
                    document.getElementById(hash).style.backgroundColor = originalColor;

                    setTimeout(() => {document.getElementById(hash).style.transitionDuration = "0s";}, 50);
                }, 1000);
            }

            document.getElementById("newbiebutton").onclick = () => {setRank("Newbie")};
            document.getElementById("intermbutton").onclick = () => { setRank("Interm") };
            document.getElementById("advancedbutton").onclick = () => { setRank("Advanced") };

            document.getElementById("changename").addEventListener("click", changename)

            const playerData = firebase.firestore().collection("users").doc(user.uid);
            playerData.get().then((doc) => {

                var time = (Date.parse(doc.data().creation) - new Date()); // milliseconds between now & user creation
                var accountCreationDifference = -Math.floor(time / 86400000); // days

                username = doc.data().username;

                document.getElementById("status").innerHTML = "Logged in as " + doc.data().username + ".";
                document.getElementById("loaded").style.display = "";

                var bannedEmails = data.bannedEmailaddresses
                for (var i = 0; i < data.bannedEmailaddresses.length; i++) {
                    if (bannedEmails[i].email == firebase.auth().currentUser.email) {
                        document.getElementById("status").innerHTML = "You have been banned. Reason: " + bannedEmails[i].reason;
                        document.getElementById("loaded").style.display = "none";
                    }
                }

                if (!doc.data().rank) {
                    console.log("no rank, creating rank...");

                    playerData.update({rank: "Newbie"}).then(() => {console.log("rank updated!")});
                    location.reload();
                } else {
                    console.log("rank found:", doc.data().rank)

                    const rank = doc.data().rank;

                    if (rank == "Newbie") {
                        document.getElementById("daysUntilNextRank").innerHTML = 121 - accountCreationDifference;

                        document.getElementById("newbiebutton").innerHTML = "Using";
                        document.getElementById("intermbutton").disabled = true;
                    } else {
                        if (accountCreationDifference >= 0) {
                            document.getElementById("newbiebutton").disabled = false;
                        }
                    }

                    if (rank == "Interm") {
                        document.getElementById("daysUntilNextRank").innerHTML = 365 - accountCreationDifference;

                        document.getElementById("intermbutton").innerHTML = "Using";
                        document.getElementById("intermbutton").disabled = true;
                    } else {
                        if (accountCreationDifference >= 121) {
                            document.getElementById("intermbutton").disabled = false;
                        }
                    }

                    if (rank == "Advanced") {
                        document.getElementById("daysUntilNextRank").parentElement.innerHTML = "Your maxed out!";

                        document.getElementById("advancedbutton").innerHTML = "Using";
                        document.getElementById("intermbutton").disabled = true;
                    } else {
                        if (accountCreationDifference >= 365) {
                            document.getElementById("advancedbutton").disabled = false;
                        }
                    }
                }

                if (accountCreationDifference >= 121) { // 4 MONTHS
                    document.getElementById("intermbutton").disabled = false;
                }

                if (accountCreationDifference >= 365) { // 1 YEAR
                    document.getElementById("advancedbutton").disabled = false;
                }

                const usernamedisplay = document.getElementById("username");
                const email = document.getElementById("email");
                const type = document.getElementById("type");
                const joindate = document.getElementById("join");
                const verified = document.getElementById("verified");
                const uid = document.getElementById("uid");

                usernamedisplay.innerHTML = username;
                email.innerHTML = doc.data().email;
                type.innerHTML = doc.data().accounttype;
                joindate.innerHTML = doc.data().creation;
                if (user.emailVerified) {
                    verified.innerHTML = `Yes! <a target="_blank" href="https://forms.gle/5rSzyNMfdTfnP9S68">Get Verified/Become a creator!</a>`;
                } else {
                    verified.innerHTML = `No <a href="../verify.html">Verify now!</a>`;
                }
                uid.innerHTML = user.uid;
            })
        });
        
        document.getElementById("changepass").addEventListener("click", changepassword);
        function changepassword() {
            firebase.auth().sendPasswordResetEmail(firebase.auth().currentUser.email).then(() => {
                alert("Check " + firebase.auth().currentUser.email + "'s inbox.");
            }).catch((err) => {
                alert(err);
            });
        }

        document.getElementById("DELETE").addEventListener("click", Deleteacc);
        function Deleteacc() {
            if (confirm("Are you sure you WANT TO DELETE THIS ACCOUNT?")) {
                const user = firebase.auth().currentUser;

                const password = prompt("Enter your password to contiune...");
                // TODO(you): prompt the user to re-provide their sign-in credentials
                const credential = firebase.auth.EmailAuthProvider.credential(
                    user.email,
                    password
                );

                user.reauthenticateWithCredential(credential).then(() => {
                    // User re-authenticated.
                    console.log("asdad")
                }).catch((error) => {
                    alert(error);
                });

                firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid).delete().then(() => {
                    firebase.auth().currentUser.delete().then(() => {
                        alert("Account deleted. Sorry to see you go!");

                    }).catch((err) => {
                        alert("Error deleting auth account: " + err);
                    })
                }).catch((err) => {
                    alert("Error deleting firestore data: " + err);
                })
            }
        }

        function setRank(rankType) {
            const playerData = firebase.firestore().collection("users").doc(firebase.auth().currentUser.uid);

            playerData.update({rank: rankType}).then(() => {
                console.log("set new rank!");
            })
        }

        function changename() {
            const newname = document.getElementById("newname").value;
            const confirm = document.getElementById("confirmnewname").value;
            let output = document.getElementById("result_text");

            if (newname == username) {
                output.innerHTML = "Your new name cant be the same as your old name!"
                return;
            }
            if (newname != confirm) {
                output.innerHTML = "The usernames entered dont match."
                return;
            }
            if (newname == "") {
                output.innerHTML = "Your new name cant be blank!"
                return;
            }

            let playerData = firebase.firestore().collection("users").doc(loggedinuser.uid);
            playerData.update({
                username: newname
            }).then((doc) => {
                output.innerHTML = "Username has been switched to " + newname + "!"
                //window.location.reload();
            })
        }
    </script>
</body>
</html>