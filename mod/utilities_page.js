import{DEVELOPER_ALLOW_LIST,auth,db,doc,getDoc,onAuthStateChanged,updateDoc,collection,query,getDocs,where,limit,ref}from"../js/util/firebase.js";import{MOD_PASS}from"../js/config.js";let activeUserId,localBadges=[];function decode_ascii85(e){var t,n,d,a,o=String,c="length",l=255,s="charCodeAt",i="slice",r="replace";for("<~"===e[i](0,2)&&e[i](-2),e=e[i](2,-2)[r](/\s/g,"")[r]("z","!!!!!"),n=[],d=0,a=(e+=r="uuuuu"[i](e[c]%5||5))[c];d<a;d+=5)t=52200625*(e[s](d)-33)+614125*(e[s](d+1)-33)+7225*(e[s](d+2)-33)+85*(e[s](d+3)-33)+(e[s](d+4)-33),n.push(l&t>>24,l&t>>16,l&t>>8,l&t);for(var u=n,m=r[c];0<m;m--)u.pop();return o.fromCharCode.apply(o,n)}async function enterPassword(){return new Promise(async(e,t)=>{document.getElementById("enterPassword").showModal();document.getElementById("passwordthing").value="",document.getElementById("unlock").addEventListener("click",()=>{document.getElementById("passwordthing").value==decode_ascii(MOD_PASS)?e(!0):e(!1),document.getElementById("enterPassword").close()},{once:!0})})}async function banUser(e,t,n){await enterPassword()||showNotification(3,"Wrong password.");e=doc(db,"users/"+e),t={reason:t};null!=n&&(t.endsOn=n),await updateDoc(e,{banned:t}),showNotification(4,`Banned! [${null==n?"PERM":"TEMP"}]`)}async function unbanUser(e){await enterPassword()||showNotification(3,"Wrong password.");e=doc(db,"users/"+e);await updateDoc(e,{banned:null}),showNotification(4,"Unbanned!")}async function loadUser(e){var t=doc(db,"users",e),t=await getDoc(t);if(t.exists()){activeUserId=e,document.getElementById("username__search").innerText=t.data().username,document.getElementById("isbanned").checked=null!=t.data().banned,document.getElementById("limitedAccess").checked=t.data().limitedAccess||!1,document.getElementById("tokens").value=t.data().tokens||0,localBadges=t.data().badges||[],console.log(localBadges),document.getElementById("badgecontainer").innerHTML="";for(let e=0;e<localBadges.length;e++){var n=document.getElementById("badgeex").cloneNode(!0);n.src="../asset/badges/"+localBadges[e].replace(" ","")+".png",n.title=localBadges[e],n.id=localBadges[e].replace(" ",""),document.getElementById("badgecontainer").appendChild(n)}document.getElementById("userdata__searchSuccess").removeAttribute("hide")}else showNotification(3,"User not found.")}function addBadge(e){var t;localBadges.includes(e)||(localBadges.push(e),(t=document.getElementById("badgeex").cloneNode(!0)).src="../asset/badges/"+e.replace(" ","")+".png",t.title=e+=" | Added locally",t.id=e.replace(" ",""),t.style.backgroundColor="rgba(0,255,0, .25)",document.getElementById("badgecontainer").appendChild(t))}function removeBadge(e){document.getElementById(e.replace(" ","")).title+=" | Deleted locally",document.getElementById(e.replace(" ","")).style.backgroundColor="rgba(255,0,0, .25)",localBadges.splice(localBadges.indexOf(e))}async function update(){var e;await enterPassword()?(e=doc(db,"users",activeUserId),await updateDoc(e,{badges:localBadges,limitedAccess:document.getElementById("limitedAccess").checked,tokens:parseInt(document.getElementById("tokens").value)}),showNotification(4,"Successfully updated data! [changes not reflected]")):showNotification(3,"Wrong password.")}onAuthStateChanged(auth,e=>{e&&DEVELOPER_ALLOW_LIST.includes(e.uid)?(document.getElementById("userDataSearch").addEventListener("click",()=>{loadUser(document.getElementById("userDataUid").value)}),document.getElementById("addBadge").addEventListener("click",()=>{addBadge(document.getElementById("badgename").value)}),document.getElementById("removeBadge").addEventListener("click",()=>{removeBadge(document.getElementById("badgename").value)}),document.getElementById("update").addEventListener("click",update),document.getElementById("userSearch").addEventListener("click",async()=>{var e=document.getElementById("userSearchName").value,t=(document.getElementById("searchuid").innerHTML="Loading...",collection(db,"users")),t=query(t,where("username","in",[e,e.toLowerCase(),e.toUpperCase()]),limit(10)),e=await getDocs(t);let n=[];if(e.forEach(e=>{n.push(e)}),console.log(n[0]),0==n.length)document.getElementById("searchuid").innerHTML="Empty.";else{document.getElementById("searchuid").innerHTML="";for(let e=0;e<n.length;e++){if(e==n.length){document.getElementById("searchuid").innerHTML+=n[e].id;break}document.getElementById("searchuid").innerHTML+=n[e].id+", "}}}),document.getElementById("banProceed").addEventListener("click",async()=>{var e=document.getElementById("banUid").value;(await getDoc(doc(db,"users",e))).exists()?document.getElementById("banUser").showModal():showNotification(1,"Not a vaild uid.")}),document.getElementById("banusernow").addEventListener("click",async()=>{var e=document.getElementById("banReason").value,t=new Date(document.getElementById("banDate").value);let n=null;document.getElementById("banPerm").value&&(n=e),banUser(document.getElementById("banUid").value,t,n)})):(alert("Permission denied."),location.href="../index.html")});