import{CountdownManager,getGameData,getKit,setActiveGame,updateData,wait,addTo,getRanks,calculateNewScore}from"../../js/hosting/tools/HostGamemodeHelper.js";import{doc,finishLoading,insertLoadingScreen,onValue,realtime,ref,updateLoadingInfo}from"../../js/util/firebase.js";let GAMEMODE_MULTIPLER=.8,gameDoc=document.getElementById("gamecontent"),game=document.game,hostData=(console.log(game),setActiveGame(game.gameId),null);function convertDictToArray(e){var t,a=[];for(t in e)e.hasOwnProperty(t)&&a.push([t,e[t]]);return a}let kit=null;async function prep(){return new Promise(async(e,t)=>{try{kit=await getKit(),hostData=(await getGameData()).data.data,document.getElementById("ingame_code").innerHTML=game.gameId,onValue(ref(realtime,"games/"+game.gameId),e=>{e=e.val();null!=e&&(hostData=e,document.getElementById("totalInGame").innerHTML=convertDictToArray(hostData.players).length)}),e()}catch(e){alert(e)}})}async function doCountdown(){await prep(),await setupLeaderboard(),await CountdownManager.doCountdown(5,()=>{document.getElementById("loadingScreen").removeAttribute("show")},document.getElementById("countdownText"),()=>{document.getElementById("countdownScreen").setAttribute("show",""),updateData({countdownToQuestion:!0})}),document.getElementById("countdownScreen").removeAttribute("show"),advanceToNextQuestion()}async function setupLeaderboard(){return new Promise(async(e,t)=>{convertDictToArray(hostData.players).forEach(e=>{var t=e[0],e=e[1],a=document.getElementById("leaderboardplayerex").cloneNode(!0);a.id="leaderboard__"+t,a.children[0].children[0].src="../asset/char/"+e.icon,a.children[0].children[1].children[0].innerText=e.username,document.getElementById("leaderboardplayers").append(a)}),e()})}function calcNewScore(e,t,a,n,o){return o<1?e:calculateNewScore(e,t,a,n,GAMEMODE_MULTIPLER)*(n?o:1)}async function advanceToNextQuestion(){console.log(hostData);for(let e=0;e<document.getElementsByClassName("correctAnswer").length;e++){var t=document.getElementsByClassName("correctAnswer")[e];"correctAnswerEx"!=t.id&&t.remove()}document.getElementsByClassName("correctAnswerReveal")[0].removeAttribute("show"),document.getElementsByClassName("leaderboardContainer")[0].setAttribute("inactive","");var e=hostData.settings.gamemodeSettings.Time.maxTime.value,a=(await updateData({activeQuestionIdx:hostData.gameData.activeQuestionIdx+1,questionActive:!1,timer:e,countdownToQuestion:!1,scoreboardActive:!1}),document.getElementById("questionTimer").innerHTML=e,kit.questions[hostData.gameData.activeQuestionIdx]);document.getElementById("questionText").innerHTML=a.question,""!=a.image&&null!=a.image&&(document.getElementById("kitimg").src=a.image);for(let e=0;e<document.getElementsByClassName("answerContainer").length;e++){var n=document.getElementsByClassName("answerContainer")[e];n.style.display="flex",console.log(e),""==a["a"+(e+1)]?n.style.display="none":n.innerText=a["a"+(e+1)]}document.getElementById("questionPreview").innerHTML='<span class="subtitle" style="font-size:.75rem">Be ready to answer this:</span>'+a.question,document.getElementById("questionPreview").setAttribute("show",""),await wait(3),await updateData({questionActive:!0}),document.getElementById("questionPreview").removeAttribute("show"),document.getElementsByClassName("questionContainer")[0].removeAttribute("inactive"),document.getElementById("totalInGame").innerHTML=convertDictToArray(hostData.players).length;let o=new AbortController;e=onValue(ref(realtime,"games/"+game.gameId+"/gameData/completedActiveQuestion"),e=>{var e=e.val();null!=e&&(e=convertDictToArray(e).length,(document.getElementById("totalAnswered").innerHTML=e)==convertDictToArray(hostData.players).length)&&o.abort("All players answered.")});await CountdownManager.doCountdown(hostData.gameData.timer,()=>{},document.getElementById("questionTimer"),null,o.signal),await updateData({questionActive:!1,timer:0}),e(),hostData.gameData.questionActive=!1,document.getElementsByClassName("correctAnswerReveal")[0].setAttribute("show","");for(let e=0;e<a.correctA.length;e++){var r=a.correctA[e],i=document.getElementById("correctAnswerEx").cloneNode(!0);i.id="correcta__"+r,i.innerHTML='<i class="fa-light fa-check"></i> '+a["a"+r],document.getElementsByClassName("correctAnswerReveal")[0].append(i)}await wait(2);for(let e=0;e<document.getElementsByClassName("correctAnswer").length;e++)document.getElementsByClassName("correctAnswer")[e].setAttribute("show","");await wait(2);var s=document.getElementsByClassName("correctAnswer");for(let e=0;e<s.length;e++){var d=s[e];"correctAnswerEx"!=d.id&&d.parentElement.removeChild(d)}document.getElementsByClassName("questionContainer")[0].setAttribute("inactive",""),document.getElementsByClassName("leaderboardContainer")[0].removeAttribute("inactive"),insertLoadingScreen("leaderboard",document.getElementsByClassName("leaderboardCenter")[0]),updateLoadingInfo("leaderboard","Updating player's scores");var l,c={};for(l in hostData.gameData.completedActiveQuestion){var m=hostData.gameData.completedActiveQuestion[l],u=a.correctA.includes(m.answer.replace("a","")),g=(hostData.gameData.scoring||{})[l]||0;let e=2;""!=a.a3&&(e+=1),""!=a.a4&&(e+=1),c[l]=g;g=Math.round(calcNewScore(g,a.correctA.length,e,u,m.time));await addTo("scoring",{[l]:g})}await updateData({scoreboardActive:!0}),finishLoading("leaderboard"),new Chart(document.getElementById("questionChart"),{labels:["Correct","Incorrect","Unanswered"],datasets:[{data:[5,2,1],backgroundColor:["rgb(138, 255, 99)","rgb(235, 54, 54)","rgb(183, 183, 183)"],hoverOffset:4}]});var w,h=getRanks(hostData.gameData.scoring);for(w in console.log(h),await wait(1),h){var y=h[w][0],v=h[w][1],A=hostData.settings.gamemodeSettings.Time.maxTime.value-((hostData.gameData.completedActiveQuestion||{})[y]||{time:0}).time,E=null==(hostData.gameData.completedActiveQuestion||{})[y];document.getElementById("leaderboard__"+y).children[0].children[1].children[1].innerHTML=E?"Took too long":`Answered in ${A} second`+(1==hostData.gameData.completedActiveQuestion[y].time?"":"s"),v-c[y]<0&&(document.getElementById("leaderboard__"+y).children[0].children[1].children[1].innerHTML="Incorrect. ("+A+"s)"),document.getElementById("leaderboard__"+y).children[1].children[0].innerHTML=0<v-c[y]?"+":""+Math.round(v-c[y]).toString(),document.getElementById("leaderboard__"+y).children[1].children[1].innerHTML=v,document.getElementById("leaderboard__"+y).style.order=-v}let D=new AbortController;document.getElementById("proceedToNextQuestion").addEventListener("click",()=>{D.abort("Continued manually.")}),document.getElementById("leaderboardContinueTimer").innerHTML=hostData.settings.gamemodeSettings.Time.maxTime.value,await CountdownManager.doCountdown(hostData.settings.gamemodeSettings.Time.maxTime.value,()=>{},document.getElementById("leaderboardContinueTimer"),null,D.signal),await updateData({completedActiveQuestion:{}}),advanceToNextQuestion()}doCountdown();