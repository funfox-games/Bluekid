import{addTo,getGameData,getKit,setActiveGame,updateData,getRanks,getPlayerName}from"../../js/hosting/tools/ClientGamemodeHelper.js";import{auth,onValue,push,realtime,realtimeUpdate,ref}from"../../js/util/firebase.js";let game=document.game,kit=(console.log(game),setActiveGame(game.gameId),null);async function prep(){return new Promise(async(e,t)=>{kit=await getKit(),getGameData(),e()})}function getProper(e){switch(e){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}async function start(){await prep(),document.getElementById("loadingScreen").removeAttribute("show","");game.ref;var e=ref(realtime,"games/"+game.gameId+"/gameData");let m=!1,l=!1,u=-1,d,g=async e=>{e.setAttribute("selected",""),u=e.getAttribute("answerID").replace("a","");e=e.getAttribute("answerID");await addTo("completedActiveQuestion",{[auth.currentUser.uid]:{answer:e,time:d}}).catch(e=>{alert("something went wrong. Please check the console.")}),document.getElementById("questionAnswered").setAttribute("show","")};onValue(e,async e=>{let t=e.val();if(null==t)console.warn("Value is null.");else{d=t.timer,console.log("recived change",t);switch(1==t.countdownToQuestion&&0==t.scoreboardActive&&t.timer<=5?"intermission":1==t.scoreboardActive?"scoreboard":0==t.countdownToQuestion&&t.questionActive&&0<t.timer&&0==t.scoreboardActive?"question":0==t.countdownToQuestion&&0==t.questionActive&&0<=t.activeQuestionIdx&&0==t.scoreboardActive?"preview":void 0){case"intermission":5!=t.timer&&(document.getElementById("countdownScreen").setAttribute("show",""),document.getElementById("countdownText").innerHTML=t.timer);break;case"scoreboard":if(!l){l=!0,document.getElementsByClassName("questionContainer")[0].setAttribute("inactive",""),document.getElementById("questionPreview").style.display="flex",document.getElementById("questionAnswered").removeAttribute("show"),document.getElementById("questionPreview").removeAttribute("show",""),document.getElementById("scoreboardContainer").removeAttribute("inactive");var n,o=(await getGameData()).data.data,r=(console.log(o),document.getElementById("correctSymbol").className="fa-light fa-circle-check",document.getElementById("correctSymbol").style.fill="rgb(152, 225, 152)",o.kitData.questions[o.gameData.gameData.activeQuestionIdx].correctA.includes(u??"0")||(document.getElementById("correctSymbol").className="fa-light fa-circle-xmark",document.getElementById("correctSymbol").style.fill="rgb(255, 152, 152)"),null==u&&(document.getElementById("correctSymbol").className="fa-light fa-circle-question",document.getElementById("correctSymbol").style.fill="rgb(174, 174, 174)"),getRanks(t.scoring));let e=null;for(n in r){var a=r[n][0],i=r[n][1],s=parseInt(n)+1;a==auth.currentUser.uid&&(document.getElementById("scoreboard__place").innerHTML=parseInt(s)+getProper(s),document.getElementById("scoreboard__score").innerHTML=parseFloat(i).toLocaleString(),document.getElementById("person_behind").parentElement.innerHTML='right behind <span id="person_behind">unknown.</span>',1==s?document.getElementById("person_behind").parentElement.innerHTML="You are first!<span id='person_behind'></span>":document.getElementById("person_behind").innerText=getPlayerName(e)),e=a}u=null}break;case"question":if(m)return;m=!0,document.getElementById("questionPreview").style.display="none",document.getElementById("questionPreview").removeAttribute("show",""),document.getElementsByClassName("questionContainer")[0].removeAttribute("inactive");var c=kit.questions[t.activeQuestionIdx];document.getElementById("questionText").innerHTML=c.question,""!=c.image&&null!=c.image?document.getElementById("kitimg").src=c.image:document.getElementById("kitimg").src="../asset/templates/kit_temp.png";for(let t=0;t<document.getElementsByClassName("answerContainer").length;t++){let e=document.getElementsByClassName("answerContainer")[t];e.style.display="flex",e.removeAttribute("selected"),""==c["a"+(t+1)]?e.style.display="none":(e.hasAttribute("func")&&e.removeEventListener("click",()=>{g(e)}),e.innerText=c["a"+(t+1)],e.setAttribute("answerID","a"+(t+1)),e.setAttribute("func",""),e.addEventListener("click",()=>{g(e)}))}break;case"preview":document.getElementById("scoreboardContainer").setAttribute("inactive",""),m=!1,document.getElementById("countdownScreen").removeAttribute("show"),document.getElementById("questionPreview").innerHTML='<span class="subtitle" style="font-size:.75rem">Be ready to answer this:</span>'+kit.questions[t.activeQuestionIdx].question,document.getElementById("questionPreview").setAttribute("show",""),l=!1;break;default:console.warn("Some unknown state is present. Can't proceed.")}}})}start();