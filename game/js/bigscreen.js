import{auth,onAuthStateChanged,realtime,realtimeGet,realtimeUpdate,ref}from"../../js/util/firebase.js";import{setupGame,removeGame,listenForEvent,init,sendEventToClients,Bluekid,gameId}from"../js/util.js";function decompileGamemodeInfo(){var e=sessionStorage.getItem("gamemode_info");return null==e?null:(e=JSON.parse(e),{info:JSON.parse(e.gamemodeInfo),settings:JSON.parse(e.gamemodeSettings)})}let getRandomInteger=(e,t)=>(e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e);function generateCode(){var e=getRandomInteger(0,9),t=getRandomInteger(0,9),n=getRandomInteger(0,9),a=getRandomInteger(0,9),r=getRandomInteger(0,9),d=getRandomInteger(0,9),e=e.toString()+t.toString()+n.toString()+a.toString()+r.toString()+d.toString();return parseInt(e)}async function kick(e){var t=ref(realtime,"games/"+gameId);let n=await realtimeGet(t);var a=(n=n.val().players).indexOf(e);n.splice(a),await realtimeUpdate(t,{players:n}),document.getElementById(e.uid).remove(),sendEventToClients(Bluekid.GetUIDPlayers(),"bluekid__updatePlayers",{players:n})}function addPlayer(e){let t=document.getElementById("playerex").cloneNode(!0);t.id=e.uid,t.addEventListener("mouseenter",()=>{t.children[0].setAttribute("show","")}),t.addEventListener("mouseleave",()=>{t.children[0].removeAttribute("show")}),t.children[0].children[0].addEventListener("click",async()=>{kick(e)}),t.children[0].children[1].href=location.origin+"/profile/user/index.html?id="+e.uid,t.children[2].innerText=e.username,e.hasAccount||t.children[0].children[1].remove(),document.getElementById("players").append(t)}document.getElementById("closeup_close").addEventListener("click",()=>{document.getElementById("closeup_bg").removeAttribute("show")}),document.getElementById("gameidcard").addEventListener("click",()=>{document.getElementById("closeup_bg").setAttribute("show","")}),onAuthStateChanged(auth,async e=>{e?(document.getElementById("interaction").showModal(),document.getElementById("clickme").addEventListener("click",async()=>{document.getElementById("interaction").close(),document.getElementById("preparing").showModal();var e=decompileGamemodeInfo(),t=generateCode(),n=(console.log("Game code: "+t),new Map(e.settings));let a={};n.forEach((e,t)=>{a[t]=e}),await setupGame(auth.currentUser,{code:t,settings:a,gamemode:e.info.id}),document.getElementById("preparing_detail").innerHTML="Updating UI",document.getElementById("gameidcard").innerHTML=t,document.getElementById("closeup_code").innerHTML=t,init(),listenForEvent("bluekid__playerjoin",async(e,t)=>{var n=await Bluekid.GetUIDPlayers();let a=await realtimeGet(ref(realtime,"games/"+gameId));a=a.val().players,addPlayer({uid:e.sender,username:t.username,hasAccount:t.hasAccount}),sendEventToClients(n,"bluekid__updatePlayers",{players:a})}),listenForEvent("bluekid__playerleave",async(e,t)=>{var n=ref(realtime,"games/"+gameId);let a=await realtimeGet(n);(a=a.val().players).splice(t.id-1),await realtimeUpdate(n,{players:a}),document.getElementById(e.sender).remove(),sendEventToClients(players,"bluekid__updatePlayers",{players:a})}),document.getElementById("preparing").close()}),window.addEventListener("beforeunload",async e=>{removeGame()})):alert("you're not logged in. what")});