import{onAuthStateChanged,auth,db,doc,getDoc,collection,storageref,storage,uploadBytes,getDownloadURL,setDoc,KIT_COVER_LOCATION,getDocs,hasBluekidPlus}from"../util/firebase.js";let currentImg="../../asset/templates/kit_temp.png",userData;import*as MediaUtil from"../util/user_media.js";let uploadedFile=!1,contentType="",fileData=null;async function checkImage(a){return new Promise((e,t)=>{var l=new Image;l.onload=function(){0<this.width&&e()},l.onerror=function(){t()},l.src=a})}async function createKit(e,t,l,a){if(20<=(await getDocs(collection(db,"users",auth.currentUser.uid,"kits"))).size+1&&!await hasBluekidPlus())document.getElementById("limitreached").showModal();else{e={displayname:e,description:t,creationdate:new Date,author:auth.currentUser.uid,visibility:l,canclone:a,cover:currentImg},t=(console.log(e),await doc(collection(db,"users",auth.currentUser.uid,"kits")));if(console.log(t.id),uploadedFile){document.getElementById("createkit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Uploading cover...';l=await uploadBytes(storageref(storage,KIT_COVER_LOCATION+"/"+t.id),fileData,{contentType:contentType}).catch(e=>(showNotification(3,"Failed to upload cover."),!1));if(0==l)return;a=await getDownloadURL(l.ref);e.cover=a}await setDoc(t,e);document.getElementById("createkit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Waiting..',location.href="../kits.html"}}onAuthStateChanged(auth,async e=>{e?(e=e.uid,e=doc(db,"users",e),userData=await getDoc(e).then(e=>e.exists()?e.data():"UNKNOWN"),console.log(new Date),document.getElementById("uploadurluse").addEventListener("click",async()=>{document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Working...',document.getElementById("uploadurlnovaild").style.display="none";var e=!0;await checkImage(document.getElementById("uploadurlurl").value).catch(()=>{document.getElementById("uploadurlnovaild").style.display="unset",document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-file-image"></i> Use',e=!1}),e&&(currentImg=document.getElementById("uploadurlurl").value,console.log(document.getElementById("uploadurlurl").value),uploadedFile=!1,document.getElementById("coverimg").src=currentImg,document.getElementById("uploadurlurl").value="",document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-file-image"></i> Use')}),document.getElementById("uploadurl").addEventListener("click",()=>{document.getElementById("uploadurldialog").showModal()}),document.getElementById("uploadfile").addEventListener("click",()=>{document.getElementById("uploadfiledialog").showModal()}),document.getElementById("uploadurlclose").addEventListener("click",()=>{document.getElementById("uploadurldialog").close()}),document.getElementById("uploadfileclose").addEventListener("click",()=>{document.getElementById("uploadfiledialog").close()}),document.getElementById("uploadFileUse").addEventListener("click",()=>{var e=document.getElementById("fileupload").files[0],t=window.URL.createObjectURL(e);uploadedFile=!0,contentType=e.type,fileData=e,document.getElementById("coverimg").src=t,document.getElementById("uploadfiledialog").close()}),document.getElementById("createkit").addEventListener("click",()=>{document.getElementById("createkit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Creating...';var e=document.getElementById("kittitle").value,t=document.getElementById("kitdesc").value,l=document.getElementById("kit_visibility").value,a=document.getElementById("canclone").checked;MediaUtil.isLimited(e,MediaUtil.MAX_CHAR_NAME)?(document.getElementById("createkit").innerHTML='<i class="fa-solid fa-square-plus"></i> Create',showNotification(3,"Title must be shorter then "+MediaUtil.MAX_CHAR_NAME+" characters. (Currently "+e.length+" characters)")):MediaUtil.isLimited(t,MediaUtil.MAX_CHAR_DESCRIPTION)?(document.getElementById("createkit").innerHTML='<i class="fa-solid fa-square-plus"></i> Create',showNotification(3,"Desc must be shorter then "+MediaUtil.MAX_CHAR_DESCRIPTION+" characters. (Currently "+t.length+" characters)")):e.length<3?(document.getElementById("createkit").innerHTML='<i class="fa-solid fa-square-plus"></i> Create',showNotification(3,"Title must be longer.")):createKit(e,t,l,a)})):location.href="../../auth/login.html"});