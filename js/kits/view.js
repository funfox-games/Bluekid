import{onAuthStateChanged,auth,db,doc,getDoc,updateDoc,FirebaseHelper,hasBluekidPlus,onSnapshot,increment,arrayUnion,arrayRemove,insertLoadingScreen,finishLoading,MODERATOR_ALLOW_LIST}from"../util/firebase.js";let kitid_url=new URL(location.href).searchParams.get("id"),likeCooldownTime=1e3;function refreshQuestions(t){console.log("Load questions");var i=document.getElementById("allQuestions").children;for(let e=0;e<i.length;e++)"ex"!=i[e].id&&i[e].remove();for(let e=0;e<t.length;e++){var n=t[e],d=(console.log(n),n.a1),o=n.a2,l=n.a3,a=n.a4,r=n.question,s=n.correctA,c=document.getElementById("ex").cloneNode(!0);c.id="",c.children[1].children[0].children[0].innerText=r,""==d?c.children[1].children[1].children[0].style.display="none":c.children[1].children[1].children[0].innerText=d,""==o?c.children[1].children[1].children[1].style.display="none":c.children[1].children[1].children[1].innerText=o,""==l?c.children[1].children[1].children[2].style.display="none":c.children[1].children[1].children[2].innerText=l,""==a?c.children[1].children[1].children[3].style.display="none":c.children[1].children[1].children[3].innerText=a,s.includes("1")&&(c.children[1].children[1].children[0].innerHTML='<i class="fa-light fa-square-check"></i> '+d),s.includes("2")&&(c.children[1].children[1].children[1].innerHTML='<i class="fa-light fa-square-check"></i> '+o),s.includes("3")&&(c.children[1].children[1].children[2].innerHTML='<i class="fa-light fa-square-check"></i> '+l),s.includes("4")&&(c.children[1].children[1].children[3].innerHTML='<i class="fa-light fa-square-check"></i> '+a),""==n.image||null==n.image?c.children[0].style.display="none":(c.children[0].children[0].src=n.image,c.children[1].children[1].style.paddingLeft="0"),document.getElementById("allQuestions").append(c)}}function updateRatio(e,t){var i;document.getElementById("notEnoughRates").style.display="none",document.getElementById("rating").setAttribute("hide",""),0==e&&0==t?document.getElementById("notEnoughRates").style.display="unset":(document.getElementById("rating").removeAttribute("hide"),i=e/(e+t),e=t/(e+t),console.log(i,e),document.getElementById("negitiveRating").style.flex=e==1/0?"0":e,document.getElementById("positiveRating").style.flex=i==1/0?"0":i)}async function updateWhoLikedPopup(t){document.getElementById("allLiked").innerHTML="",insertLoadingScreen("likedLoading",document.getElementById("likedPeople")),document.getElementById("likedPeople").showModal();for(let e=0;e<t.length;e++){var i=t[e],n=(document.getElementById("nolikes").setAttribute("hide",""),await getDoc(doc(db,"users",i))),d=document.getElementById("likedex").cloneNode(!0);d.id="",d.href="../user/index.html?id="+i,null!=n.data().profileBlue&&(d.children[0].src="../../asset/char/"+n.data().profileBlue),d.children[1].innerText=n.data().username,document.getElementById("allLiked").append(d)}finishLoading("likedLoading")}async function updateWhoDislikedPopup(t){if(0==MODERATOR_ALLOW_LIST.includes(auth.currentUser.uid))showNotification(3,"Not a moderator.");else{document.getElementById("allDisliked").innerHTML="",insertLoadingScreen("likedLoading",document.getElementById("dislikedPeople")),document.getElementById("dislikedPeople").showModal();for(let e=0;e<t.length;e++){var i=t[e],n=(document.getElementById("nodislikes").setAttribute("hide",""),await getDoc(doc(db,"users",i))),d=document.getElementById("likedex").cloneNode(!0);d.id="",d.href="../user/index.html?id="+i,null!=n.data().profileBlue&&(d.children[0].src="../../asset/char/"+n.data().profileBlue),d.children[1].innerText=n.data().username,document.getElementById("allDisliked").append(d)}finishLoading("likedLoading")}}function loadDescription(e=""){let n=[];for(;1==e.includes("<k:");)e=e.replace(/<k:[\s\S]*?>/,(e,t,i)=>{e=e.replace("<k:","").replace(">","");return n.push(e),`<a class="kitReference" id="kit_reference_${e}" href="./view.html?id=${e}"><i style="--fa-animation-duration: 500ms;--fa-animation-timing:ease-in-out" class="fa-regular fa-spinner-third fa-spin"></i> Loading... <span style="font-size:.5rem;opacity:.5;">${e}</span></a>`}),document.getElementById("desc").innerHTML=e;document.getElementById("desc").innerHTML=e,n.forEach(async(e,t)=>{if(document.getElementById("kit_reference_"+e)){var i=await getDoc(doc(db,"kits",e));if(!i.exists())return'<a class="kitReference" href="#"><i class="fa-regular fa-layer-group"></i> UNDEFINED</a>';document.getElementById("kit_reference_"+e).innerHTML='<i class="fa-regular fa-layer-group"></i> ';var n=document.createElement("div");n.innerHTML=i.data().preview.title,document.getElementById("kit_reference_"+e).innerHTML+=n.textContent}})}let kitref=null,kit_=null,kit=null,kitdata=null;onAuthStateChanged(auth,async e=>{try{if(e)if(kitref=doc(db,"kits",kitid_url),(kit_=await getDoc(kitref)).exists()){var l=(await getDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId))).data();if("private"==l.visibility)document.getElementById("notOwned").showModal(),document.getElementById("visibility").innerHTML=l.visibility;else{if("friends"==l.visibility){document.getElementById("preformingchecks").showModal();var a=await getDoc(doc(db,"kits",kitid_url)).then(async e=>({data:(await getDoc(doc(db,"users",e.data().ownerUid))).data(),res:e}));if(document.getElementById("preformingchecks").close(),!a.data.friends.includes(e.uid)&&e.uid!=a.res.data().ownerUid)return document.getElementById("visibility").innerHTML=l.visibility,void document.getElementById("notOwned").showModal()}if(document.getElementById("kitname").innerText=l.displayname,console.log(l),null==l.publicInfo&&(l.publicInfo={hosted:0,verified:!1,peopleWhoLike:[],peopleWhoDislike:[]},await updateDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),l)),document.getElementById("kitType").innerHTML=(s=l.type||"Legacy").charAt(0).toUpperCase()+s.slice(1),document.getElementById("hostedAmount").innerHTML=l.publicInfo.hosted||0,onSnapshot(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),e=>{l=e.data(),document.getElementById("upvotes").innerHTML=(l.publicInfo.peopleWhoLike||[]).length,document.getElementById("downvotes").innerHTML=(l.publicInfo.peopleWhoDislike||[]).length,updateRatio((l.publicInfo.peopleWhoLike||[]).length,(l.publicInfo.peopleWhoDislike||[]).length)}),(l.publicInfo.peopleWhoLike||[]).includes(auth.currentUser.uid)&&document.getElementById("rateup").classList.add("primary"),(l.publicInfo.peopleWhoDislike||[]).includes(auth.currentUser.uid)&&document.getElementById("ratedown").classList.add("primary"),document.getElementById("upvotes").innerHTML=(l.publicInfo.peopleWhoLike||[]).length,document.getElementById("downvotes").innerHTML=(l.publicInfo.peopleWhoDislike||[]).length,updateRatio(l.publicInfo.upVotes,l.publicInfo.downVotes),document.getElementById("author").innerText="@"+(await FirebaseHelper.getUserData(l.author)).username,document.getElementById("author").href="../user/index.html?id="+l.author,l.bkpOnly&&(document.getElementById("kitplus").removeAttribute("hide"),!await hasBluekidPlus())){document.getElementById("bkponly").setAttribute("show",""),document.getElementById("allQuestions").setAttribute("bkponly","");for(let e=0;e<l.questions.length;e++){var r=document.getElementById("ex").cloneNode(!0);r.id="",document.getElementById("allQuestions").append(r)}document.getElementById("questionamount").innerHTML=l.questions.length,document.getElementById("clonekit").setAttribute("disabled",""),document.getElementById("hostkit").setAttribute("disabled","")}loadDescription(l.description),document.getElementById("coverimg").src=l.cover,l.bkpOnly&&await hasBluekidPlus()?null!=l.questions&&(refreshQuestions(l.questions),document.getElementById("questionamount").innerHTML=l.questions.length):0==(l.bkpOnly||!1)&&(refreshQuestions(l.questions),document.getElementById("questionamount").innerHTML=l.questions.length);let t=await getDoc(doc(db,"users",auth.currentUser.uid)),i=(null!=t.data().favoriteKits&&t.data().favoriteKits.includes(kitid_url)&&(document.getElementById("favoritekit").innerHTML='<i class="fa-solid fa-star"></i> Favorited kit'),!1),n=(null!=t.data().favoriteKits&&t.data().favoriteKits.includes(kitid_url)&&(i=!0),document.getElementById("favoritekit").addEventListener("click",async()=>{var e;document.getElementById("favoritekit").innerHTML="Working...",document.getElementById("favoritekit").setAttribute("disabled",""),i=i?((e=t.data().favoriteKits||[])!=[]&&e.splice(e.indexOf(kitid_url),1),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e}),document.getElementById("favoritekit").innerHTML='<i class="fa-light fa-star"></i> Favorite kit',document.getElementById("favoritekit").removeAttribute("disabled"),!1):((e=t.data().favoriteKits||[]).push(kitid_url),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e}),document.getElementById("favoritekit").innerHTML='<i class="fa-solid fa-star"></i> Favorited kit',document.getElementById("favoritekit").removeAttribute("disabled"),!0)}),async()=>new Promise(async(e,t)=>{var i=l.publicInfo,n=i.peopleWhoLike||[];n.splice(n.indexOf(auth.currentUser.uid),1),i.peopleWhoLike=n,await updateDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),{publicInfo:i}),document.getElementById("rateup").classList.remove("primary"),e()})),d=async()=>new Promise(async(e,t)=>{var i=l.publicInfo,n=i.peopleWhoDislike||[];n.splice(n.indexOf(auth.currentUser.uid),1),i.peopleWhoDislike=n,await updateDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),{publicInfo:i}),document.getElementById("ratedown").classList.remove("primary"),e()}),o=(document.getElementById("rateup").addEventListener("contextmenu",e=>{updateWhoLikedPopup(l.publicInfo.peopleWhoLike),e.preventDefault()}),document.getElementById("ratedown").addEventListener("contextmenu",e=>{updateWhoDislikedPopup(l.publicInfo.peopleWhoDislike),e.preventDefault()}),!1);document.getElementById("rateup").addEventListener("click",async()=>{var e,t;l.author==auth.currentUser.uid?showNotification(3,"Cannot dislike / like your own kit."):1==o?showNotification(2,"Limit hit, please wait a second."):(o=!0,setTimeout(()=>{o=!1},likeCooldownTime),(l.publicInfo.peopleWhoDislike||[]).includes(auth.currentUser.uid)&&await d(),(l.publicInfo.peopleWhoLike||[]).includes(auth.currentUser.uid)?n():(console.log("adding like"),(t=(e=l.publicInfo).peopleWhoLike||[]).push(auth.currentUser.uid),e.peopleWhoLike=t,updateDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),{publicInfo:e}),console.log("added like"),document.getElementById("rateup").classList.add("primary")))}),document.getElementById("ratedown").addEventListener("click",async()=>{var e,t;l.author==auth.currentUser.uid?showNotification(3,"Cannot dislike / like your own kit."):1==o?showNotification(2,"Limit hit, please wait a second."):(o=!0,setTimeout(()=>{o=!1},likeCooldownTime),(l.publicInfo.peopleWhoLike||[]).includes(auth.currentUser.uid)&&await n(),(l.publicInfo.peopleWhoDislike||[]).includes(auth.currentUser.uid)?d():((t=(e=l.publicInfo).peopleWhoDislike||[]).push(auth.currentUser.uid),e.peopleWhoDislike=t,updateDoc(doc(db,"users",kit_.data().ownerUid,"kits",kit_.data().kitId),{publicInfo:e}),document.getElementById("ratedown").classList.add("primary")))}),l.bkpOnly&&await hasBluekidPlus()&&document.getElementById("clonekit").addEventListener("click",()=>{alert("Cloning isn't supported yet.")})}}else document.getElementById("nonexistant").showModal();else location.href="../../auth/login.html"}catch(e){alert("Something went wrong: "+e)}var s}),document.onload=async()=>{kitref=doc(db,"kits",kitid_url),0!=(kit_=await getDoc(kitref)).exists()&&(document.head.append(`<meta name="description" content="${kit_.data().preview.description}">`),document.head.append(`<meta property="og:url" content="${location.href}">`),document.head.append(`<meta property="og:image" content="${kit_.data().preview.icon}">`),document.head.append(`<meta property="og:title" content="${kit_.data().preview.title}">`),document.head.append(`<meta property="og:description" content="${kit_.data().preview.description}">`))};