import{onAuthStateChanged,auth,db,doc,getDoc,deleteDoc,setDoc,updateDoc,KIT_COVER_LOCATION,storageref,storage,uploadBytes,getDownloadURL,deleteObject,listAll,addDoc,collection,hasBluekidPlus}from"../util/firebase.js";import*as MediaUtil from"../util/user_media.js";let kitid_url=new URL(location.href).searchParams.get("id"),questions=[],hasSaved=!0,uploadedFile=!1,contentType="",fileData=null,currentCover="";function refreshQuestions(){var t=document.getElementById("allQuestions").children;for(let e=0;e<t.length;e++)"ex"!=t[e].id&&t[e].remove();for(let t=0;t<questions.length;t++){var n=questions[t],l=(console.log(n),n.a1),i=n.a2,d=n.a3,o=n.a4,a=n.question,s=n.correctA;let e=document.getElementById("ex").cloneNode(!0);e.id="",e.children[1].children[0].innerText=a,e.children[1].children[1].children[0].innerText=l,e.children[1].children[1].children[1].innerText=i,e.children[1].children[1].children[2].innerText=d,e.children[1].children[1].children[3].innerText=o,s.includes("1")&&(e.children[1].children[1].children[0].innerHTML='<i class="fa-solid fa-square-check"></i> '+l),s.includes("2")&&(e.children[1].children[1].children[1].innerHTML='<i class="fa-solid fa-square-check"></i> '+i),s.includes("3")&&(e.children[1].children[1].children[2].innerHTML='<i class="fa-solid fa-square-check"></i> '+d),s.includes("4")&&(e.children[1].children[1].children[3].innerHTML='<i class="fa-solid fa-square-check"></i> '+o),""==n.image||null==n.image?e.children[0].style.display="none":e.children[0].children[0].src=n.image,e.children[1].children[2].addEventListener("click",()=>{questions.splice(t,1),e.remove()}),document.getElementById("allQuestions").append(e)}}async function saveKit(){return new Promise(async(e,t)=>{var n=document.getElementById("kitname").value,l=document.getElementById("desc").value;let i=document.getElementById("coverimg").src;var d=doc(db,"users",auth.currentUser.uid,"kits",kitid_url);if(uploadedFile&&i!=currentCover){document.getElementById("savekit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Uploading cover...';var o=await uploadBytes(storageref(storage,KIT_COVER_LOCATION+"/"+kitid_url),fileData,{contentType:contentType}).catch(e=>(showNotification(3,"Failed to upload cover."),!1));if(0==o)return;var o=await getDownloadURL(o.ref);i=o,document.getElementById("coverimg").src=i}await updateDoc(d,{displayname:n,description:l,cover:i,questions:questions,visibility:document.getElementById("kit_visibility").value}).catch(e=>t(e)),currentCover=i,"private"!=document.getElementById("kit_visibility").value?(document.getElementById("savekit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Uploading...',o=doc(db,"kits",kitid_url),await setDoc(o,{kitId:kitid_url,ownerUid:auth.currentUser.uid,preview:{icon:i,title:n,description:l,visibility:document.getElementById("kit_visibility").value}})):(document.getElementById("savekit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Checking...',d=doc(db,"kits",kitid_url),(await getDoc(d)).exists()&&(document.getElementById("savekit").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Removing...',await deleteDoc(d))),e()})}async function checkImage(l){return new Promise((e,t)=>{var n=new Image;n.onload=function(){0<this.width&&e()},n.onerror=function(){t()},n.src=l})}onAuthStateChanged(auth,async e=>{var t;e?(e=e.uid,e=doc(db,"users",e,"kits",kitid_url),(e=await getDoc(e)).exists()?(e=e.data(),document.getElementById("kitname").value=e.displayname,document.getElementById("desc").value=e.description,document.getElementById("coverimg").src=e.cover,currentCover=e.cover,null!=e.questions&&(questions=e.questions),refreshQuestions(),document.getElementById("kit_visibility").value=e.visibility,document.getElementById("questionamount").innerHTML=questions.length,document.getElementById("changecoverfile").addEventListener("click",()=>{document.getElementById("uploadfiledialog").showModal()}),document.getElementById("createquestion__btn").addEventListener("click",()=>{var t,n=document.getElementById("questiontext").value,l=document.getElementById("q1a").checked,i=document.getElementById("q1").value,d=document.getElementById("q2a").checked,o=document.getElementById("q2").value,a=document.getElementById("q3a").checked,s=document.getElementById("q3").value,u=document.getElementById("q4a").checked,r=document.getElementById("q4").value,c=document.getElementById("qimg").src;if(MediaUtil.isLimited(n,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question text needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${n.length})`;else if(MediaUtil.isLimited(i,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 1 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${i.length})`;else if(MediaUtil.isLimited(o,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 2 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${o.length})`;else if(MediaUtil.isLimited(s,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 3 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${s.length})`;else if(MediaUtil.isLimited(r,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 4 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${r.length})`;else if(""==n)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question text required.";else if(""==i)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question 1 required.";else if(""==o)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question 3 required.";else{let e=!1;(e=l||d||a||u?!0:e)?(document.getElementById("problem").parentElement.style.display="none",document.getElementById("problem").innerHTML="",t=[],l&&t.push("1"),d&&t.push("2"),a&&t.push("3"),u&&t.push("4"),console.log(c),questions.push({a1:i,a2:o,a3:s,a4:r,correctA:t,question:n,image:c==location.href?"":c}),hasSaved=!1,document.getElementById("createquestionpopup").close(),refreshQuestions()):(document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Need at least one correct answer.")}}),document.getElementById("createquestion").addEventListener("click",()=>{var e=document.getElementById("questiontext"),t=document.getElementById("q1a"),n=document.getElementById("q1"),l=document.getElementById("q2a"),i=document.getElementById("q2"),d=document.getElementById("q3a"),o=document.getElementById("q3"),a=document.getElementById("q4a"),s=document.getElementById("q4");e.value="",n.value="",t.checked=!1,i.value="",l.checked=!1,o.value="",d.checked=!1,s.value="",a.checked=!1,document.getElementById("qimg").src="",document.getElementById("createquestionpopup").showModal()}),document.getElementById("savekit").addEventListener("click",async()=>{var e=document.getElementById("kitname").value,t=document.getElementById("desc").value;MediaUtil.isLimited(e,MediaUtil.MAX_CHAR_NAME)?showNotification(3,"Title must be shorter then "+MediaUtil.MAX_CHAR_NAME+" characters. (Currently "+e.length+" characters)"):MediaUtil.isLimited(t,MediaUtil.MAX_CHAR_DESCRIPTION)?showNotification(3,"Desc must be shorter then "+MediaUtil.MAX_CHAR_DESCRIPTION+" characters. (Currently "+t.length+" characters)"):e.length<3?showNotification(3,"Title must be longer."):(document.getElementById("savekit").innerHTML="Waiting...",document.getElementById("savekit").setAttribute("disabled","true"),await saveKit(),document.getElementById("savekit").innerHTML='<i class="fa-solid fa-floppy-disk"></i> Save kit',document.getElementById("savekit").removeAttribute("disabled"))}),document.getElementById("changecoverurl").addEventListener("click",()=>{document.getElementById("uploadurldialog").showModal()}),document.getElementById("uploadurlquestion").addEventListener("click",()=>{document.getElementById("uploadurldialog__question").showModal()}),document.getElementById("uploadurlclose__question").addEventListener("click",()=>{document.getElementById("uploadurldialog__question").close()}),document.getElementById("uploadurluse").addEventListener("click",async()=>{document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Working...',document.getElementById("uploadurlnovaild").style.display="none";var e=!0;await checkImage(document.getElementById("uploadurlurl").value).catch(()=>{document.getElementById("uploadurlnovaild").style.display="unset",document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-file-image"></i> Use',e=!1}),e&&(console.log(document.getElementById("uploadurlurl").value),document.getElementById("coverimg").src=document.getElementById("uploadurlurl").value,document.getElementById("uploadurlurl").value="",document.getElementById("uploadurluse").innerHTML='<i class="fa-solid fa-file-image"></i> Use',document.getElementById("uploadurldialog").close())}),document.getElementById("uploadFileUse").addEventListener("click",async()=>{var e,t=document.getElementById("fileupload").files[0];"image/gif"!=t.type||await hasBluekidPlus()?5e6<t.size&&!await hasBluekidPlus()?document.getElementById("toobig").showModal():(e=window.URL.createObjectURL(t),uploadedFile=!0,contentType=t.type,fileData=t,document.getElementById("coverimg").src=e):document.getElementById("gif").showModal(),document.getElementById("uploadfiledialog").close()}),document.getElementById("uploadurluse__question").addEventListener("click",async()=>{document.getElementById("uploadurluse__question").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Working...',document.getElementById("uploadurlnovaild__question").style.display="none";var e=!0;await checkImage(document.getElementById("uploadurlurl__question").value).catch(()=>{document.getElementById("uploadurlnovaild__question").style.display="unset",document.getElementById("uploadurlus__questione").innerHTML='<i class="fa-solid fa-file-image"></i> Use',e=!1}),e&&(console.log(document.getElementById("uploadurlurl__question").value),document.getElementById("qimg").src=document.getElementById("uploadurlurl__question").value,document.getElementById("uploadurlurl__question").value="",document.getElementById("uploadurluse__question").innerHTML='<i class="fa-solid fa-file-image"></i> Use',document.getElementById("uploadurldialog__question").close())}),document.getElementById("covercontainer").addEventListener("mouseenter",()=>{document.getElementById("cover__overlay").setAttribute("show","")}),document.getElementById("covercontainer").addEventListener("mouseleave",()=>{document.getElementById("cover__overlay").removeAttribute("show")}),document.getElementById("share_kit").addEventListener("click",()=>{navigator.clipboard.writeText("https://bluekid.netlify.app/profile/kit/view?id="+kitid_url),showNotification(4,"Copied share url to clipboard!")}),document.getElementById("delete_kit").addEventListener("click",async()=>{document.getElementById("delete_kit").innerHTML="Working...",document.getElementById("delete_kit").setAttribute("disabled",""),await deleteDoc(doc(db,"users",auth.currentUser.uid,"kits",kitid_url)),await deleteDoc(doc(db,"kits",kitid_url));var e=storageref(storage,KIT_COVER_LOCATION+"/"+kitid_url),t=await listAll(storageref(storage,KIT_COVER_LOCATION));let n=!1;console.log(KIT_COVER_LOCATION+kitid_url),t.items.forEach(e=>{e.name==kitid_url&&(n=!0,console.log("found"))}),n&&(console.log("hasCover"),await deleteObject(e)),location.href="../kits.html"}),t=await getDoc(doc(db,"kits",kitid_url)),"private"!=e.visibility&&!t.exists()||document.getElementById("publish_kit").remove()):location.href="../kits.html"):location.href="../../auth/login.html"}),window.addEventListener("beforeunload",function(e){var t;if(!hasSaved)return t="It looks like you have been editing something. If you leave before saving, your changes will be lost.",(e||window.event).returnValue=t});