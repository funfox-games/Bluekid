import{onAuthStateChanged,onSnapshot,auth,db,doc,getDoc,deleteDoc,setDoc,updateDoc,KIT_COVER_LOCATION,storageref,storage,uploadBytes,getDownloadURL,deleteObject,listAll,addDoc,collection,hasBluekidPlus}from"../util/firebase.js";import*as MediaUtil from"../util/user_media.js";let kitid_url=new URL(location.href).searchParams.get("id"),questions=[],hasSaved=!0,uploadedFile=!1,contentType="",fileData=null,currentCover="",bluekidPlusOnly=!1;function refreshQuestions(){var t=document.getElementById("allQuestions").children;for(let e=0;e<t.length;e++)"ex"!=t[e].id&&t[e].remove();for(let t=0;t<questions.length;t++){var n=questions[t],l=(console.log(n),n.a1),i=n.a2,d=n.a3,o=n.a4,a=n.question,c=n.correctA;let e=document.getElementById("ex").cloneNode(!0);e.id="",e.children[1].children[0].children[0].innerText=a,""==l?e.children[1].children[1].children[0].style.display="none":e.children[1].children[1].children[0].innerText=l,""==i?e.children[1].children[1].children[1].style.display="none":e.children[1].children[1].children[1].innerText=i,""==d?e.children[1].children[1].children[2].style.display="none":e.children[1].children[1].children[2].innerText=d,""==o?e.children[1].children[1].children[3].style.display="none":e.children[1].children[1].children[3].innerText=o,c.includes("1")&&(e.children[1].children[1].children[0].setAttribute("correct",""),e.children[1].children[1].children[0].innerHTML='<i class="fa-light fa-square-check"></i> '+l),c.includes("2")&&(e.children[1].children[1].children[1].setAttribute("correct",""),e.children[1].children[1].children[1].innerHTML='<i class="fa-light fa-square-check"></i> '+i),c.includes("3")&&(e.children[1].children[1].children[2].setAttribute("correct",""),e.children[1].children[1].children[2].innerHTML='<i class="fa-light fa-square-check"></i> '+d),c.includes("4")&&(e.children[1].children[1].children[3].setAttribute("correct",""),e.children[1].children[1].children[3].innerHTML='<i class="fa-light fa-square-check"></i> '+o),""==n.image||null==n.image?e.children[0].style.display="none":(e.children[0].children[0].src=n.image,e.children[1].children[1].style.paddingLeft="0"),e.children[1].children[0].children[1].children[0].addEventListener("click",()=>{questions.splice(t,1),e.remove()}),document.getElementById("allQuestions").append(e)}}async function saveKit(){return new Promise(async(e,t)=>{var n=document.getElementById("kitname").value,l=document.getElementById("desc").value;let i=document.getElementById("coverimg").src;var d=doc(db,"users",auth.currentUser.uid,"kits",kitid_url);if(uploadedFile&&i!=currentCover){document.getElementById("savekit").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Uploading cover...';var o=await uploadBytes(storageref(storage,KIT_COVER_LOCATION+"/"+kitid_url),fileData,{contentType:contentType}).catch(e=>(showNotification(3,"Failed to upload cover."),!1));if(0==o)return;o=await getDownloadURL(o.ref);i=o,document.getElementById("coverimg").src=i}var o=await getDoc(d);await updateDoc(d,{displayname:n,description:l,cover:i,questions:questions,visibility:document.getElementById("kit_visibility").value,bkpOnly:bluekidPlusOnly,publicInfo:{hosted:(o.data().publicInfo||{}).hosted||0,verified:(o.data().publicInfo||{}).verified||!1,peopleWhoLike:(o.data().publicInfo||{}).peopleWhoLike||[],peopleWhoDislike:(o.data().publicInfo||{}).peopleWhoDislike||[]}}).catch(e=>t(e)),currentCover=i,"private"!=document.getElementById("kit_visibility").value?(document.getElementById("savekit").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Uploading...',d=doc(db,"kits",kitid_url),await setDoc(d,{kitId:kitid_url,ownerUid:auth.currentUser.uid,preview:{icon:i,title:n,description:l,visibility:document.getElementById("kit_visibility").value}})):(document.getElementById("savekit").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Checking...',o=doc(db,"kits",kitid_url),(await getDoc(o)).exists()&&(document.getElementById("savekit").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Removing...',await deleteDoc(o))),hasSaved=!0,changed(),e()})}async function checkImage(l){return new Promise((e,t)=>{var n=new Image;n.onload=function(){0<this.width&&e()},n.onerror=function(){t()},n.src=l})}function changed(){bluekidPlusOnly?document.getElementById("pluskit").removeAttribute("hide"):document.getElementById("pluskit").setAttribute("hide",""),hasSaved?document.getElementsByClassName("unsaved")[0].style.display="none":document.getElementsByClassName("unsaved")[0].style.display="flex"}onAuthStateChanged(auth,async e=>{if(e)try{var t=e.uid,l=doc(db,"users",t,"kits",kitid_url),i=await getDoc(l);if(i.exists()){var d=i.data();document.getElementById("kitname").value=d.displayname,document.getElementById("desc").value=d.description,document.getElementById("coverimg").src=d.cover,currentCover=d.cover,bluekidPlusOnly=d.bkpOnly||!1,document.getElementById("onlyBkp").checked=bluekidPlusOnly;let n=document.getElementsByClassName("statContainer")[0].innerHTML;onSnapshot(l,e=>{o(e.data())}),o(d),changed(),null!=d.questions&&(questions=d.questions),refreshQuestions(),document.getElementById("kit_visibility").value=d.visibility,"private"!=d.visibility?document.getElementById("viewPublicLink").href="./view.html?id="+kitid_url:document.getElementById("viewPublicLink").style.display="none",document.getElementById("questionamount").innerHTML=questions.length,1==await hasBluekidPlus()?document.getElementById("onlyBkp").addEventListener("change",()=>{bluekidPlusOnly=document.getElementById("onlyBkp").checked,hasSaved=!1,changed()}):document.getElementById("onlyBkp").setAttribute("disabled","");for(let e=0;e<document.getElementsByClassName("saveableProperty").length;e++)document.getElementsByClassName("saveableProperty")[e].addEventListener("change",()=>{hasSaved=!1,changed()});function o(e){var t;"private"==e.visibility?document.getElementsByClassName("statContainer")[0].innerHTML=`
                <h1>Stats</h1>
                <p>Kit not available to others, no data is available to be shown.</p>
            `:0==((e.publicInfo||{}).peopleWhoLike||[]).length||0==((e.publicInfo||{}).peopleWhoDislike||[]).length?document.getElementById("likes").parentElement.innerHTML="Not enough likes or dislikes.":(document.getElementsByClassName("statContainer")[0].innerHTML=n,document.getElementById("likes").innerHTML=(e.publicInfo.peopleWhoLike||[]).length,document.getElementById("dislikes").innerHTML=(e.publicInfo.peopleWhoDislike||[]).length,t=(t=((e.publicInfo||{}).peopleWhoLike||[]).length)/(t+((e.publicInfo||{}).peopleWhoDislike||[]).length)*100,document.getElementById("likePercentile").innerHTML=t)}function a(e){document.getElementById("imgDragDrop").removeAttribute("show");e=window.URL.createObjectURL(e);document.getElementById("qimg").src=e}document.getElementById("uploadImgBtn").addEventListener("click",()=>{document.getElementById("uploadQuestionImg").click()}),document.getElementById("qimg").parentElement.addEventListener("dragover",e=>{e.preventDefault(),document.getElementById("imgDragDrop").setAttribute("show","")}),document.getElementById("qimg").parentElement.addEventListener("drop",e=>{e.preventDefault(),e.dataTransfer.items?[...e.dataTransfer.items].forEach((e,t)=>{"file"===e.kind&&a(e.getAsFile())}):[...e.dataTransfer.files].forEach((e,t)=>{a(e)})}),document.getElementById("uploadQuestionImg").addEventListener("change",e=>a(document.getElementById("uploadQuestionImg").files[0])),document.getElementById("advancedSettingsBtn").addEventListener("click",()=>{document.getElementById("sectioncontent").setAttribute("advanced",""),document.getElementById("sectioncontent").removeAttribute("main"),document.getElementById("kitactions").style.display="none"}),document.getElementById("closeAdvancedSettings").addEventListener("click",()=>{document.getElementById("sectioncontent").setAttribute("main",""),document.getElementById("sectioncontent").removeAttribute("advanced"),document.getElementById("kitactions").style.display="flex"}),document.getElementById("createquestion__btn").addEventListener("click",()=>{var t,n=document.getElementById("questiontext").value,l=document.getElementById("q1a").checked,i=document.getElementById("q1").value,d=document.getElementById("q2a").checked,o=document.getElementById("q2").value,a=document.getElementById("q3a").checked,c=document.getElementById("q3").value,s=document.getElementById("q4a").checked,r=document.getElementById("q4").value,u=document.getElementById("qimg").src;if(MediaUtil.isLimited(n,MediaUtil.MAX_KIT_QUESTION))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question text needs to be shorter than ${MediaUtil.MAX_KIT_QUESTION} characters. (Currently ${n.length})`;else if(MediaUtil.isLimited(i,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 1 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${i.length})`;else if(MediaUtil.isLimited(o,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 2 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${o.length})`;else if(MediaUtil.isLimited(c,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 3 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${c.length})`;else if(MediaUtil.isLimited(r,MediaUtil.MAX_CHAR_NAME))document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML=`Question 4 needs to be shorter than ${MediaUtil.MAX_CHAR_NAME} characters. (Currently ${r.length})`;else if(""==n)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question text required.";else if(""==i)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question 1 required.";else if(""==o)document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Question 3 required.";else{let e=!1;(e=l||d||a||s?!0:e)?(document.getElementById("problem").parentElement.style.display="none",document.getElementById("problem").innerHTML="",t=[],l&&t.push("1"),d&&t.push("2"),a&&t.push("3"),s&&t.push("4"),console.log(u),questions.push({a1:i,a2:o,a3:c,a4:r,correctA:t,question:n,image:u==location.href?"":u}),hasSaved=!1,changed(),document.getElementById("createquestionpopup").close(),refreshQuestions()):(document.getElementById("problem").parentElement.style.display="unset",document.getElementById("problem").innerHTML="Need at least one correct answer.")}}),document.getElementById("createquestion").addEventListener("click",()=>{var e=document.getElementById("questiontext"),t=document.getElementById("q1a"),n=document.getElementById("q1"),l=document.getElementById("q2a"),i=document.getElementById("q2"),d=document.getElementById("q3a"),o=document.getElementById("q3"),a=document.getElementById("q4a"),c=document.getElementById("q4");e.value="",n.value="",t.checked=!1,i.value="",l.checked=!1,o.value="",d.checked=!1,c.value="",a.checked=!1,document.getElementById("qimg").src="",document.getElementById("createquestionpopup").showModal()}),document.getElementById("savekit").addEventListener("click",async()=>{var e=document.getElementById("kitname").value,t=document.getElementById("desc").value;MediaUtil.isLimited(e,MediaUtil.MAX_CHAR_NAME)?showNotification(3,"Title must be shorter then "+MediaUtil.MAX_CHAR_NAME+" characters. (Currently "+e.length+" characters)"):MediaUtil.isLimited(t,MediaUtil.MAX_CHAR_DESCRIPTION)?showNotification(3,"Desc must be shorter then "+MediaUtil.MAX_CHAR_DESCRIPTION+" characters. (Currently "+t.length+" characters)"):e.length<3?showNotification(3,"Title must be longer."):(document.getElementById("savekit").innerHTML="Waiting...",document.getElementById("savekit").setAttribute("disabled","true"),await saveKit(),document.getElementById("savekit").innerHTML='<i class="fa-light fa-floppy-disk"></i> Save kit',document.getElementById("savekit").removeAttribute("disabled"))}),document.getElementById("changecoverurl").addEventListener("click",()=>{document.getElementById("uploadurldialog").showModal()}),document.getElementById("uploadurluse").addEventListener("click",async()=>{document.getElementById("uploadurluse").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Working...',document.getElementById("uploadurlnovaild").style.display="none";var e=!0;await checkImage(document.getElementById("uploadurlurl").value).catch(()=>{document.getElementById("uploadurlnovaild").style.display="unset",document.getElementById("uploadurluse").innerHTML='<i class="fa-light fa-file-image"></i> Use',e=!1}),e&&(console.log(document.getElementById("uploadurlurl").value),document.getElementById("coverimg").src=document.getElementById("uploadurlurl").value,document.getElementById("uploadurlurl").value="",document.getElementById("uploadurluse").innerHTML='<i class="fa-light fa-file-image"></i> Use',document.getElementById("uploadurldialog").close())}),document.getElementById("uploadFileUse").addEventListener("click",async()=>{var e,t=document.getElementById("fileupload").files[0];"image/gif"!=t.type&&"image/webp"!=t.type||await hasBluekidPlus()?5e6<t.size&&!await hasBluekidPlus()?document.getElementById("toobig").showModal():(e=window.URL.createObjectURL(t),uploadedFile=!0,contentType=t.type,fileData=t,document.getElementById("coverimg").src=e):document.getElementById("gif").showModal(),document.getElementById("uploadfiledialog").close()}),document.getElementById("covercontainer").addEventListener("mouseenter",()=>{document.getElementById("cover__overlay").setAttribute("show","")}),document.getElementById("covercontainer").addEventListener("mouseleave",()=>{document.getElementById("cover__overlay").removeAttribute("show")})}else location.href="../kits.html"}catch(e){alert(e)}else location.href="../../auth/login.html"}),window.addEventListener("beforeunload",function(e){var t;if(!hasSaved)return t="It looks like you have been editing something. If you leave before saving, your changes will be lost.",(e||window.event).returnValue=t});