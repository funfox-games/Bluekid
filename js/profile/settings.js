import{onAuthStateChanged,auth,db,doc,getDoc,deleteDoc,updateDoc,sendPasswordResetEmail,deleteUser,updateEmail,httpsCallable,functions,hasBluekidPlus,Timestamp,EmailAuthProvider,reauthenticateWithCredential}from"../util/firebase.js";import{isUserVaild,UserReasons}from"../util/auth_helper.js";import*as MediaUtil from"../util/user_media.js";async function checkVaild(a,s){return new Promise(async(e,t)=>{var n=isUserVaild(a,s);if(n.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(n.reason==UserReasons.BANNED)(i=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(i),i.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(n.reason==UserReasons.TEMPBANNED){var i=document.createElement("dialog"),o=1e3*n.endsOn.seconds,o=new Date(o).getTime();let e=Math.floor((o-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((o-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((o-Date.now())/6e4),t="minutes"),i.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(i),i.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else n.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}async function saveProfileSettings(e){return new Promise(async(e,t)=>{var n=document.getElementById("showBlues").value,i=document.getElementById("showGameHistory").value,o=document.getElementById("showKits").value,a=document.getElementById("hideTokens").checked,s=document.getElementById("showStatus").value,d=document.getElementById("showLastOnline").value,l=document.getElementById("acceptFriendRequests").checked,c=document.getElementById("primarycolor").value,m=document.getElementById("secondarycolor").value;await updateDoc(doc(db,"users",auth.currentUser.uid),{communitySettings:{privacy:{showBlues:n,showGameHistory:i,showKits:o,hideTokens:a,showStatus:s,showLastOnline:d},allowFriendRequests:l},profileSettings:{primaryColor:c,secondaryColor:m}}),e()})}let activeTab="",tabSaved=!1;function switchTab(e){if(document.getElementById(activeTab)&&document.getElementById(activeTab).hasAttribute("needs_saved")&&0==tabSaved&&activeTab!=e&&!confirm("This section has unsaved changes... Are you sure?"))location.hash="#sect."+activeTab;else{var t=document.getElementById("content").children;for(let e=0;e<t.length;e++)t[e].removeAttribute("active");null==document.getElementById(e)?console.warn(`Tab not found... [${e}]`):(tabSaved=!1,activeTab=e,document.getElementById(e).setAttribute("active",""))}}onAuthStateChanged(auth,async o=>{if(o){var a=o.uid,s=doc(db,"users",a),d=await getDoc(s).then(e=>e.data()),s=(await checkVaild(o,d),window.addEventListener("hashchange",e=>{switchTab(window.location.hash.replace("#sect.",""))}),switchTab(window.location.hash.replace("#sect.","")),document.getElementById("showBlues")),l=document.getElementById("showGameHistory"),c=document.getElementById("showKits"),m=document.getElementById("hideTokens"),r=document.getElementById("showStatus"),u=document.getElementById("showLastOnline"),g=document.getElementById("acceptFriendRequests");let e=document.getElementById("primarycolor"),t=document.getElementById("secondarycolor");var h=null!=d.communitySettings&&null!=d.communitySettings.privacy,y=null!=d.profileSettings;h&&(s.value=d.communitySettings.privacy.showBlues,l.value=d.communitySettings.privacy.showGameHistory,c.value=d.communitySettings.privacy.showKits,m.checked=d.communitySettings.privacy.hideTokens,r.value=d.communitySettings.privacy.showStatus,u.value=d.communitySettings.privacy.showLastOnline,g.value=d.communitySettings.allowFriendRequests),y&&(e.value=d.profileSettings.primaryColor,t.value=d.profileSettings.secondaryColor);let n=()=>{document.getElementById("clrpreview").style.backgroundImage=`linear-gradient(${e.value}, ${t.value})`};n(),e.addEventListener("input",()=>{n()}),t.addEventListener("input",()=>{n()});var E=document.getElementsByClassName("activesubscription");for(let e=0;e<E.length;e++)E[e].style.display="none";if(await hasBluekidPlus()){var f=document.getElementsByClassName("beforepurchase");for(let e=0;e<f.length;e++)f[e].style.display="none";for(let e=0;e<E.length;e++)E[e].style.display="flex";h=(await httpsCallable(functions,"bmacDetails")()).data,s=(document.getElementById("payeremail").innerText=h.bmac.payer_email,document.getElementById("subscriptionId").innerHTML=h.bmac.transaction_id,document.getElementById("subtype").innerHTML=h.bmac.subscription_duration_type,new Date(h.bmac.subscription_current_period_end)),l=s-new Date,c=Math.round(l/864e5);document.getElementById("renewalspan").innerHTML=c,document.getElementById("transactionToggle").addEventListener("click",()=>{document.getElementById("subscriptionId").toggleAttribute("hide")}),document.getElementById("emailToggle").addEventListener("click",()=>{document.getElementById("payeremail").toggleAttribute("hide")}),document.getElementById("unlink").addEventListener("click",()=>{document.getElementById("unlinkmembership").showModal()});let e=!0;document.getElementById("unlink_understand").addEventListener("change",()=>{0!=e&&(document.getElementById("unlink_understand").checked?document.getElementById("confirmunlink").removeAttribute("disabled"):document.getElementById("confirmunlink").setAttribute("disabled",""))}),document.getElementById("confirmunlink").addEventListener("click",async()=>{document.getElementById("confirmunlink").innerHTML;document.getElementById("confirmunlink").setAttribute("disabled",""),document.getElementById("confirmunlink").innerHTML="Authenticating...",e=!1,document.getElementById("confirmunlink").innerHTML="Verifying...",await updateDoc(doc(db,"users",auth.currentUser.uid),{subscriptionDetails:null}),alert("Success!"),location.hash="#sect.accountinfo",location.reload()});m=new Timestamp(h.firebase.confirmationDate._seconds,h.firebase.confirmationDate._nanoseconds).toDate();document.getElementById("membersince").title=m,document.getElementById("membersince").innerHTML=m.toLocaleDateString()}let i=o.email;if(document.getElementById("confirmEmail").innerText=i,null!=document.getElementById("confirmMember")){document.getElementById("confirmMember").addEventListener("click",()=>{document.getElementById("membershipConfirmation").showModal()}),document.getElementById("continueMembershipConfirmation").addEventListener("click",()=>{document.getElementById("membershipConfirmation").close(),document.getElementById("membershipConfirmation2").showModal()}),document.getElementById("useDiffEmail").addEventListener("click",()=>{document.getElementById("switchEmailCheck").showModal()}),document.getElementById("switchEmailCheckBack").addEventListener("click",()=>{document.getElementById("switchEmailCheck").close()}),document.getElementById("switchEmailCheck").addEventListener("submit",e=>{i=document.getElementById("switchedEmail").value,document.getElementById("switchedEmail").value="",document.getElementById("confirmEmail").innerText=i}),document.getElementById("resetToAccountEmail").addEventListener("click",()=>{i=o.email,document.getElementById("confirmEmail").innerText=i});let t=document.getElementById("confirmMembership").innerHTML;document.getElementById("confirmMembership").addEventListener("click",async()=>{document.getElementById("confirmMembership").setAttribute("disabled",""),document.getElementById("confirmMembership").innerHTML='<i class="fa-solid fa-spinner fa-spin fa-xl"></i> Checking...';var e=await httpsCallable(functions,"verifyBluekidPlus")(i).catch(e=>{var t=e.code;return console.error(t,e.message,e.details),showNotification(3,"Something went wrong, check the console."),null});document.getElementById("membershipConfirmation2").close(),console.log(e),null!=e&&("bkp/not_active"==e.data.status?showNotification(3,'Subscription is not active. Subscribe <a href="https://buymeacoffee.com/funfox/membership">here</a>.'):"bkp/email_in_use"==e.data.status?showNotification(3,'Email is already in use. Subscribe <a href="https://buymeacoffee.com/funfox/membership">here</a>.'):showNotification(4,`Confirmation sent to ${i}, make sure to check your spam folder.`)),document.getElementById("confirmMembership").removeAttribute("disabled"),document.getElementById("confirmMembership").innerHTML=t})}document.getElementById("openprofile").href=location.origin+"/profile/user/index.html?id="+a,document.getElementById("userid").innerHTML=a,document.getElementById("tokens").innerHTML=d.tokens,document.getElementById("username").innerHTML=d.username,document.getElementById("saveProfileSettings").addEventListener("click",async()=>{document.getElementById("saveProfileSettings").innerHTML="Saving...",document.getElementById("saveProfileSettings").setAttribute("disabled",""),await saveProfileSettings(d),document.getElementById("saveProfileSettings").removeAttribute("disabled"),document.getElementById("saveProfileSettings").innerHTML='<i class="fa-solid fa-floppy-disk"></i> Save all profile settings'}),document.getElementById("changename").addEventListener("click",async()=>{document.getElementById("changename").innerHTML='<i class="fa-solid fa-hourglass"></i> Waiting...';var e,t=document.getElementById("newname").value;t!=document.getElementById("confirmnewname").value?(document.getElementById("changename").innerHTML='<i class="fa-solid fa-shuffle"></i> Change name',showNotification(3,"New name and confirmation dont match.")):t.length<3?(document.getElementById("changename").innerHTML='<i class="fa-solid fa-shuffle"></i> Change name',showNotification(3,"Must be longer then 3 characters.")):MediaUtil.isLimited(t,MediaUtil.MAX_CHAR_NAME)?(document.getElementById("changename").innerHTML='<i class="fa-solid fa-shuffle"></i> Change name',showNotification(3,"Name must be shorter then "+MediaUtil.MAX_CHAR_NAME+" characters. (Currently "+t.length+" characters)")):(e=doc(db,"users",a),await updateDoc(e,{username:t}),console.log("yippe!"),showNotification(4,"New name applied! Refresh to show."),document.getElementById("changename").innerHTML='<i class="fa-solid fa-shuffle"></i> Change name')}),document.getElementById("sendpasswordreset").addEventListener("click",async()=>{document.getElementById("sendpasswordreset").innerHTML='<i class="fa-solid fa-hourglass fa-spin"></i> Sending...',await sendPasswordResetEmail(auth,o.email),showNotification(4,"Email sent! (Check your spam folder)"),document.getElementById("sendpasswordreset").innerHTML='<i class="fa-solid fa-envelope"></i> Send password reset email'}),document.getElementById("changemail").addEventListener("click",async()=>{var e=document.getElementById("newemail").value,t=document.getElementById("confirmemail").value;console.log(e,o.email),e!=o.email?showNotification(3,"Not original email."):(document.getElementById("changemail").innerHTML='<i class="fa-solid fa-hourglass"></i> Waiting...',document.getElementById("changemail").setAttribute("disabled",""),console.log(t),await updateEmail(o,t).catch(e=>{console.log(e),showNotification(3,"Something went wrong: "+e)}),showNotification(4,"Success!"))}),document.getElementById("deleteaccount").addEventListener("click",()=>{document.getElementById("deleteaccountdialog").showModal()}),document.getElementById("confirmdelete").addEventListener("click",async()=>{document.getElementById("confirmdelete").innerHTML="Working...",document.getElementById("confirmdelete").setAttribute("disabled",""),"WAAAAAA"!=await deleteDoc(doc(db,"users",o.uid)).catch(e=>(console.error(e),"WAAAAAA"))&&"WAAAAAA"!=await deleteUser(o).catch(e=>(console.error(e),"WAAAAAA"))&&(location.href="../index.html")});var b=document.getElementById("content").children;for(let e=0;e<b.length;e++){var B=b[e];B.hasAttribute("needs_saved")&&document.getElementById(B.getAttribute("needs_saved")).addEventListener("click",()=>{tabSaved=!0})}}else location.href="../auth/login.html"});