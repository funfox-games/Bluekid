import{onAuthStateChanged,auth,db,doc,getDoc,deleteDoc,updateDoc,sendPasswordResetEmail,deleteUser,updateEmail,httpsCallable,functions,hasBluekidPlus,Timestamp,EmailAuthProvider,reauthenticateWithCredential,isLinkedWithProvider,supportedProviders,linkWithCredential,unlink,linkWithPopup,GoogleAuthProvider}from"../util/firebase.js";import{isUserVaild,UserReasons}from"../util/auth_helper.js";import*as MediaUtil from"../util/user_media.js";async function checkVaild(a,d){return new Promise(async(e,t)=>{var n=isUserVaild(a,d);if(n.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(n.reason==UserReasons.BANNED)(o=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(o),o.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(n.reason==UserReasons.TEMPBANNED){var o=document.createElement("dialog"),i=1e3*n.endsOn.seconds,i=new Date(i).getTime();let e=Math.floor((i-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((i-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((i-Date.now())/6e4),t="minutes"),o.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(o),o.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else n.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}async function saveProfileSettings(e){return new Promise(async(e,t)=>{var n=document.getElementById("showBlues").value,o=document.getElementById("showGameHistory").value,i=document.getElementById("showKits").value,a=document.getElementById("hideTokens").checked,d=document.getElementById("showStatus").value,l=document.getElementById("showLastOnline").value,s=document.getElementById("acceptFriendRequests").checked,c=document.getElementById("showPage").value,m=document.getElementById("primarycolor").value,r=document.getElementById("secondarycolor").value;await updateDoc(doc(db,"users",auth.currentUser.uid),{communitySettings:{privacy:{showBlues:n,showGameHistory:o,showKits:i,hideTokens:a,showStatus:d,showLastOnline:l,showLastPage:c},allowFriendRequests:s},profileSettings:{primaryColor:m,secondaryColor:r}}),e()})}let activeTab="",tabSaved=!1;function switchTab(e){if(document.getElementById(activeTab)&&document.getElementById(activeTab).hasAttribute("needs_saved")&&0==tabSaved&&activeTab!=e&&!confirm("This section has unsaved changes... Are you sure?"))location.hash="#sect."+activeTab;else{var t=document.getElementsByClassName("section");for(let e=0;e<t.length;e++)t[e].removeAttribute("active");null==document.getElementById(e)?console.warn(`Tab not found... [${e}]`):(tabSaved=!1,activeTab=e,document.getElementById(e).setAttribute("active",""))}}function convertDictToArray(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push([t,e[t]]);return n}async function addConnectListner(e){switch(e){case"password":document.getElementById("addPassword").showModal();break;case"google.com":let e=new GoogleAuthProvider;const t=!1;await linkWithPopup(auth.currentUser,e).catch(e=>{showNotification(3,"Problem connecting: "+e),t=!0});t||location.reload();break;default:console.warn("Selected provider is either not supported or is invalid.")}}async function unlinkprovider(n){return new Promise(async(e,t)=>{await unlink(auth.currentUser,n).catch(e=>{t(e)}),e()})}onAuthStateChanged(auth,async d=>{if(d)if(d.isAnonymous)location.href="../auth/login.html";else{var l=d.uid,s=doc(db,"users",l),c=await getDoc(s).then(e=>e.data()),s=(await checkVaild(d,c),""==window.location.hash&&(window.location.hash="#sect.default"),window.addEventListener("hashchange",e=>{switchTab(window.location.hash.replace("#sect.",""))}),switchTab(window.location.hash.replace("#sect.","")),document.getElementById("showBlues")),m=document.getElementById("showGameHistory"),r=document.getElementById("showKits"),u=document.getElementById("hideTokens"),g=document.getElementById("showStatus"),h=document.getElementById("showLastOnline"),y=document.getElementById("showPage"),f=document.getElementById("acceptFriendRequests");let e=document.getElementById("primarycolor"),t=document.getElementById("secondarycolor");var E=null!=c.communitySettings&&null!=c.communitySettings.privacy,p=null!=c.profileSettings;E&&(s.value=c.communitySettings.privacy.showBlues??"friends",m.value=c.communitySettings.privacy.showGameHistory??"friends",r.value=c.communitySettings.privacy.showKits??"all",u.checked=c.communitySettings.privacy.hideTokens??!1,g.value=c.communitySettings.privacy.showStatus??"all",h.value=c.communitySettings.privacy.showLastOnline??"all",y.value=c.communitySettings.privacy.showLastPage??"friends",f.value=c.communitySettings.allowFriendRequests??!0),p&&(e.value=c.profileSettings.primaryColor,t.value=c.profileSettings.secondaryColor);let n=()=>{document.getElementById("clrpreview").style.backgroundImage=`linear-gradient(${e.value}, ${t.value})`};n(),e.addEventListener("input",()=>{n()}),t.addEventListener("input",()=>{n()}),null!=localStorage.getItem("settings-allowThemes")&&(document.getElementById("allowThemes").checked="true"==localStorage.getItem("settings-allowThemes")),null!=localStorage.getItem("settings-allowProfileThemes")&&(document.getElementById("allowProfileThemes").checked="true"==localStorage.getItem("settings-allowProfileThemes")),null!=localStorage.getItem("settings-optimizeProfiles")&&(document.getElementById("optimizeProfiles").checked="true"==localStorage.getItem("settings-optimizeProfiles")),document.getElementById("allowThemes").addEventListener("change",()=>{var e=document.getElementById("allowThemes").checked;localStorage.setItem("settings-allowThemes",e)}),document.getElementById("allowProfileThemes").addEventListener("change",()=>{var e=document.getElementById("allowProfileThemes").checked;localStorage.setItem("settings-allowProfileThemes",e)}),document.getElementById("optimizeProfiles").addEventListener("change",()=>{var e=document.getElementById("optimizeProfiles").checked;localStorage.setItem("settings-optimizeProfiles",e)}),null!=c.profileBlue&&(document.getElementById("featuredblue").children[0].src="../asset/char/"+c.profileBlue);var B=document.getElementsByClassName("activesubscription");for(let e=0;e<B.length;e++)B[e].style.display="none";if(await hasBluekidPlus()){var I=document.getElementsByClassName("beforepurchase");for(let e=0;e<I.length;e++)I[e].style.display="none";for(let e=0;e<B.length;e++)B[e].style.display="flex";E=(await httpsCallable(functions,"bmacDetails")()).data,s=new Date;let e;e=11==s.getMonth()?new Date(s.getFullYear()+1,0,1):new Date(s.getFullYear(),s.getMonth()+1,1),document.getElementById("monthlyCoins").innerHTML=Math.round((e-new Date)/864e5),document.getElementById("monthlyCoins").title=e,document.getElementById("payeremail").innerText=E.bmac.payer_email,document.getElementById("subscriptionId").innerHTML=E.bmac.transaction_id,document.getElementById("subtype").innerHTML=E.bmac.subscription_duration_type;m=new Date(E.bmac.subscription_current_period_end)-new Date,r=Math.round(m/864e5);document.getElementById("renewalspan").innerHTML=r,document.getElementById("transactionToggle").addEventListener("click",()=>{document.getElementById("subscriptionId").toggleAttribute("hide")}),document.getElementById("emailToggle").addEventListener("click",()=>{document.getElementById("payeremail").toggleAttribute("hide")}),document.getElementById("unlink").addEventListener("click",()=>{document.getElementById("unlinkmembership").showModal()});let t=!0;document.getElementById("unlink_understand").addEventListener("change",()=>{0!=t&&(document.getElementById("unlink_understand").checked?document.getElementById("confirmunlink").removeAttribute("disabled"):document.getElementById("confirmunlink").setAttribute("disabled",""))}),document.getElementById("confirmunlink").addEventListener("click",async()=>{document.getElementById("confirmunlink").innerHTML;document.getElementById("confirmunlink").setAttribute("disabled",""),document.getElementById("confirmunlink").innerHTML="Authenticating...",t=!1,document.getElementById("confirmunlink").innerHTML="Verifying...",await updateDoc(doc(db,"users",auth.currentUser.uid),{subscriptionDetails:null}),alert("Success!"),location.hash="#sect.accountinfo",location.reload()});u=new Timestamp(E.firebase.confirmationDate._seconds,E.firebase.confirmationDate._nanoseconds).toDate();document.getElementById("membersince").title=u,document.getElementById("membersince").innerHTML=u.toLocaleDateString()}var v=convertDictToArray(supportedProviders);let o=!1;for(let t=0;t<v.length;t++){let e=v[t][1];console.log(e),"password"==e.name&&(o=!0);var w=isLinkedWithProvider(e);if(console.log(e.name,w),w.connected){var b=document.getElementById(e.connectedId),k=(b.classList.remove("ex"),b.children[0]);null!=w.data.photo&&(k.children[0].src=w.data.photo),null!=w.data.username&&(k.children[1].innerText=`${w.data.username} (${w.data.email})`);let n=b.children[1].getElementsByClassName("removebtn")[0];null!=n&&n.addEventListener("click",async()=>{if(o){n.setAttribute("disabled","");let t=!(n.innerHTML="Waiting...");await unlinkprovider(e.name).catch(e=>{n.removeAttribute("disabled"),n.innerHTML=e,t=!0}),t||location.reload()}else document.getElementById("needpass").showModal()})}else{k=document.getElementById(e.linkId);k.classList.remove("ex"),k.children[1].addEventListener("click",()=>{addConnectListner(e.name)})}}0==isLinkedWithProvider({name:"password"}).connected&&(document.getElementById("addpasswordbtn").removeAttribute("disabled"),document.getElementById("sendpasswordreset").setAttribute("disabled",""));let i=d.email;if(document.getElementById("confirmEmail").innerText=i,null!=document.getElementById("confirmMember")){document.getElementById("confirmMember").addEventListener("click",()=>{document.getElementById("membershipConfirmation").showModal()}),document.getElementById("continueMembershipConfirmation").addEventListener("click",()=>{document.getElementById("membershipConfirmation").close(),document.getElementById("membershipConfirmation2").showModal()}),document.getElementById("useDiffEmail").addEventListener("click",()=>{document.getElementById("switchEmailCheck").showModal()}),document.getElementById("switchEmailCheckBack").addEventListener("click",()=>{document.getElementById("switchEmailCheck").close()}),document.getElementById("switchEmailCheck").addEventListener("submit",e=>{i=document.getElementById("switchedEmail").value,document.getElementById("switchedEmail").value="",document.getElementById("confirmEmail").innerText=i}),document.getElementById("resetToAccountEmail").addEventListener("click",()=>{i=d.email,document.getElementById("confirmEmail").innerText=i});let t=document.getElementById("confirmMembership").innerHTML;document.getElementById("confirmMembership").addEventListener("click",async()=>{document.getElementById("confirmMembership").setAttribute("disabled",""),document.getElementById("confirmMembership").innerHTML='<i class="fa-light fa-spinner fa-spin fa-xl"></i> Checking...';var e=await httpsCallable(functions,"verifyBluekidPlus")(i).catch(e=>{var t=e.code;return console.error(t,e.message,e.details),showNotification(3,"Something went wrong, check the console."),null});document.getElementById("membershipConfirmation2").close(),console.log(e),null!=e&&("bkp/not_active"==e.data.status?showNotification(3,'Subscription is not active. Subscribe <a href="https://buymeacoffee.com/funfox/membership">here</a>.'):"bkp/email_in_use"==e.data.status?showNotification(3,'Email is already in use. Subscribe <a href="https://buymeacoffee.com/funfox/membership">here</a>.'):showNotification(4,`Confirmation sent to ${i}, make sure to check your spam folder.`)),document.getElementById("confirmMembership").removeAttribute("disabled"),document.getElementById("confirmMembership").innerHTML=t})}document.getElementById("openprofile").href=location.origin+"/profile/user/index.html?id="+l,document.getElementById("userid").innerHTML=l,document.getElementById("tokens").innerHTML=c.tokens,document.getElementById("username").innerHTML=c.username;let a=document.getElementById("addpassconfirm").innerHTML;document.getElementById("addpasswordinput").addEventListener("input",()=>{document.getElementById("addpassconfirm").removeAttribute("disabled"),document.getElementById("addpassconfirm").style.backgroundColor="",document.getElementById("addpassconfirm").innerHTML=a}),document.getElementById("confirmpasswordinput").addEventListener("input",()=>{document.getElementById("addpassconfirm").removeAttribute("disabled"),document.getElementById("addpassconfirm").style.backgroundColor="",document.getElementById("addpassconfirm").innerHTML=a}),document.getElementById("addpassconfirm").addEventListener("click",async()=>{document.getElementById("addpassconfirm").setAttribute("disabled",""),document.getElementById("addpassconfirm").innerHTML='<i class="fa-duotone fa-solid fa-spinner-third fa-spin" style="font-size:2rem;"></i>';var e=document.getElementById("addpasswordinput").value;if(e!=document.getElementById("confirmpasswordinput").value)document.getElementById("addpassconfirm").style.backgroundColor="#f54542",document.getElementById("addpassconfirm").innerHTML='<i class="fa-light fa-circle-xmark"></i> Passwords not the same';else if(""==e)document.getElementById("addpassconfirm").style.backgroundColor="#f54542",document.getElementById("addpassconfirm").innerHTML='<i class="fa-light fa-circle-xmark"></i> Password cannot be empty';else{e=EmailAuthProvider.credential(auth.currentUser.email,e);let t=!1;await linkWithCredential(auth.currentUser,e).catch(e=>{t=!0,document.getElementById("addpassconfirm").style.backgroundColor="#f54542",document.getElementById("addpassconfirm").innerHTML='<i class="fa-light fa-circle-xmark"></i> '+e}),t||(document.getElementById("addpassconfirm").innerHTML='<i class="fa-duotone fa-solid fa-circle-check" style="font-size:2rem;"></i>',location.reload())}}),document.getElementById("saveProfileSettings").addEventListener("click",async()=>{document.getElementById("saveProfileSettings").innerHTML="Saving...",document.getElementById("saveProfileSettings").setAttribute("disabled",""),await saveProfileSettings(c),document.getElementById("saveProfileSettings").removeAttribute("disabled"),document.getElementById("saveProfileSettings").innerHTML='<i class="fa-light fa-floppy-disk"></i> Save all profile settings'}),document.getElementById("changename").addEventListener("click",async()=>{document.getElementById("changename").innerHTML='<i class="fa-light fa-hourglass"></i> Waiting...';var e,t=document.getElementById("newname").value;t!=document.getElementById("confirmnewname").value?(document.getElementById("changename").innerHTML='<i class="fa-light fa-shuffle"></i> Change name',showNotification(3,"New name and confirmation dont match.")):t.length<3?(document.getElementById("changename").innerHTML='<i class="fa-light fa-shuffle"></i> Change name',showNotification(3,"Must be longer then 3 characters.")):MediaUtil.isLimited(t,MediaUtil.MAX_CHAR_NAME)?(document.getElementById("changename").innerHTML='<i class="fa-light fa-shuffle"></i> Change name',showNotification(3,"Name must be shorter then "+MediaUtil.MAX_CHAR_NAME+" characters. (Currently "+t.length+" characters)")):(e=doc(db,"users",l),await updateDoc(e,{username:t}),console.log("yippe!"),showNotification(4,"New name applied! Refresh to show."),document.getElementById("changename").innerHTML='<i class="fa-light fa-shuffle"></i> Change name')}),document.getElementById("sendpasswordreset").addEventListener("click",async()=>{document.getElementById("sendpasswordreset").innerHTML='<i class="fa-light fa-hourglass fa-spin"></i> Sending...',await sendPasswordResetEmail(auth,d.email),showNotification(4,"Email sent! (Check your spam folder)"),document.getElementById("sendpasswordreset").innerHTML='<i class="fa-light fa-envelope"></i> Send password reset email'}),document.getElementById("changemail").addEventListener("click",async()=>{var e=document.getElementById("newemail").value,t=document.getElementById("confirmemail").value;console.log(e,d.email),e!=d.email?showNotification(3,"Not original email."):(document.getElementById("changemail").innerHTML='<i class="fa-light fa-hourglass"></i> Waiting...',document.getElementById("changemail").setAttribute("disabled",""),console.log(t),await updateEmail(d,t).catch(e=>{console.log(e),showNotification(3,"Something went wrong: "+e)}),showNotification(4,"Success!"))}),document.getElementById("deleteaccount").addEventListener("click",()=>{document.getElementById("deleteaccountdialog").showModal()}),document.getElementById("confirmdelete").addEventListener("click",async()=>{document.getElementById("confirmdelete").innerHTML="Working...",document.getElementById("confirmdelete").setAttribute("disabled",""),"WAAAAAA"!=await deleteDoc(doc(db,"users",d.uid)).catch(e=>(console.error(e),"WAAAAAA"))&&"WAAAAAA"!=await deleteUser(d).catch(e=>(console.error(e),"WAAAAAA"))&&(location.href="../index.html")});var L=document.getElementsByClassName("section");for(let e=0;e<L.length;e++){var T=L[e];T.hasAttribute("needs_saved")&&document.getElementById(T.getAttribute("needs_saved")).addEventListener("click",()=>{tabSaved=!0})}}else location.href="../auth/login.html"});