import{onAuthStateChanged,auth,db,doc,getDoc,signOut,query,where,getDocs,limit,collection,FirebaseHelper,ONLINE_TEXT,updateDoc,OFFLINE_TEXT,hasBluekidPlus,insertLoadingScreen,updateLoadingInfo,finishLoading}from"../util/firebase.js";import{isUserVaild,UserReasons}from"../util/auth_helper.js";async function checkVaild(i,d){return new Promise(async(e,t)=>{var n=isUserVaild(i,d);if(n.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(n.reason==UserReasons.BANNED)(a=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(a),a.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(n.reason==UserReasons.TEMPBANNED){var a=document.createElement("dialog"),s=1e3*n.endsOn.seconds,s=new Date(s).getTime();let e=Math.floor((s-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((s-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((s-Date.now())/6e4),t="minutes"),a.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(a),a.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else n.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}function updateFriends(d,r){return new Promise(async(e,t)=>{var n=await getDoc(doc(db,"users",d)).then(e=>e.data());let a=[],s=[];null!=n.friends&&(a=n.friends),null!=n.requests&&(s=n.requests),a.push(r),s.splice(s.indexOf(r),1);n=await getDoc(doc(db,"users",r)).then(e=>e.data());let i=[];(i=null!=n.friends?n.friends:i).push(d);n=n.sentRequests;n.splice(n.indexOf(d),1),await updateDoc(doc(db,"users",d),{friends:a,requests:s}),await updateDoc(doc(db,"users",r),{friends:i,sentRequests:n}),e()})}async function loadFriendRequests(i){return new Promise(async(e,t)=>{try{var n=i.requests;if(null==n);else for(let e=0;e<n.length;e++){null!=document.getElementById("norequests")&&document.getElementById("norequests").remove();let t=n[e];var a=await getDoc(doc(db,"users",t)).then(e=>e),s=a.data();if(0!=a.exists()){let e=document.getElementById("requestex").cloneNode(!0);e.id="",e.children[0].children[0].innerText=s.username,e.children[0].children[1].innerText="UID: "+t,e.children[1].children[0].addEventListener("click",async()=>{e.children[1].children[0].innerHTML="Working...",e.children[1].children[0].setAttribute("disabled","true"),await CommunityUtilites.acceptFriendReq(auth.currentUser,t),e.remove(),location.reload()}),e.children[1].children[1].addEventListener("click",async()=>{e.children[1].children[1].innerHTML="Working...",e.children[1].children[1].setAttribute("disabled","true"),await CommunityUtilites.ignoreFriendReq(auth.currentUser,t),showNotification(4,"Success! Some factors may not be updated so please refresh."),e.remove()}),e.children[1].children[2].addEventListener("click",async()=>{showNotification(3,"no. not yet")}),document.getElementById("allRequests").append(e)}}e()}catch(e){updateLoadingInfo("content","Error: "+e)}})}async function loadSentRequests(a){return new Promise(async(e,t)=>{var n=a.sentRequests;if(null!=n){updateLoadingInfo("content","Init sent loading");for(let t=0;t<n.length;t++)try{updateLoadingInfo("content","Loading elem #"+t),null!=document.getElementById("nosentrequests")&&document.getElementById("nosentrequests").remove();let a=n[t];var s=await getDoc(doc(db,"users",a)).then(e=>e),i=s.data();if(0!=s.exists()){let n=document.getElementById("sentrequestex").cloneNode(!0);n.id="",n.children[0].children[0].innerText=i.username,n.children[0].children[1].innerText="UID: "+a,n.children[1].children[0].addEventListener("click",async()=>{n.children[1].children[0].innerHTML="Working...",n.children[1].children[0].setAttribute("disabled","true");var e=auth.currentUser.uid,e=doc(db,"users",e),t=[],e=((t=(await getDoc(e).then(e=>e.data())).sentRequests).splice(t.indexOf(a),1),await updateDoc(e,{sentRequests:t}),doc(db,"users",a)),t=[];(t=(await getDoc(e).then(e=>e.data())).requests).splice(t.indexOf(a),1),await updateDoc(e,{requests:t}),showNotification(4,"Success! Some factors may not be updated so please refresh."),n.remove()}),document.getElementById("allSentRequests").append(n)}}catch(e){updateLoadingInfo("content","Error on element #"+t+": "+e)}updateLoadingInfo("content","Finished")}e()})}let limitReached=async e=>{var t=await hasBluekidPlus();return 50<=e&&!t},friendlgtnh=0;async function loadFriends(){return new Promise(async(e,t)=>{var n,a=await(await fetch("https://bluekidapi.netlify.app/.netlify/functions/api/social",{headers:{user:auth.currentUser.uid,"Content-Type":"application/json"}})).json();console.log(a),await limitReached(a.length)&&(document.getElementById("limitReached").setAttribute("show",""),document.getElementById("addfriend").setAttribute("disabled","")),friendlgtnh=a.length;for(let e=0;e<a.length;e++){null!=document.getElementById("nofriends")&&document.getElementById("nofriends").remove();let d=a[e],r=document.getElementById("friendex").cloneNode(!0);console.log(d),0==d.deleted&&null!=d.data.profileBlue&&(r.children[0].src="../asset/char/"+d.data.profileBlue),r.children[1].href="./user/index.html?id="+d.uid,1!=d.deleted&&(r.children[1].children[0].innerText=d.data.username,r.id=d.data.username,n=async()=>{var e,t,n,a,s,i=await FirebaseHelper.getUserStatus(d.uid);i.status==ONLINE_TEXT&&(r.children[1].children[1].innerHTML=ONLINE_TEXT,r.children[1].children[1].style.color="lime",d.data.communitySettings)&&"none"==d.data.communitySettings.privacy.showStatus&&(r.children[1].children[1].innerHTML=""),i.status==OFFLINE_TEXT&&(i=-(Date.parse(i.lastOnline)-new Date),e=Math.floor(i/1e3),t=Math.floor(i/6e4),n=Math.floor(i/864e5),a=Math.floor(i/36e5),s=Math.floor(i/6048e5),0<(i=Math.floor(i/2628e6))?r.children[1].children[1].innerHTML=`Last online ${i} month${1==i?"":"s"} ago.`:0<s?r.children[1].children[1].innerHTML=`Last online ${s} week${1==s?"":"s"} ago.`:0<n?r.children[1].children[1].innerHTML=`Last online ${n} day${1==n?"":"s"} ago.`:0<a?r.children[1].children[1].innerHTML=`Last online ${a} hour${1==a?"":"s"} ago.`:0<t?r.children[1].children[1].innerHTML=`Last online ${t} minute${1==t?"":"s"} ago.`:0<e&&(r.children[1].children[1].innerHTML=`Last online ${e} second${1==e?"":"s"} ago.`),r.children[1].children[1].style.color="rgb(200,200,200)",d.data.communitySettings&&"none"==d.data.communitySettings.privacy.showStatus&&(r.children[1].children[1].innerHTML=""),d.data.communitySettings)&&"none"==d.data.communitySettings.privacy.showLastOnline&&(r.children[1].children[1].innerHTML=OFFLINE_TEXT)},setInterval(n,5e3),n(),document.getElementById("allFriends").append(r))}e()})}async function searchUsers(s){return new Promise(async(e,t)=>{var n=collection(db,"users"),n=query(n,where("username","in",[s,s.toLowerCase(),s.toUpperCase()]),limit(10)),n=await getDocs(n);let a=[];n.forEach(e=>{a.push(e)}),console.log(a),e(a)})}async function sendRequest(i){return new Promise(async(e,t)=>{var n=doc(db,"users",auth.currentUser.uid),a=await getDoc(n).then(e=>e.data().sentRequests);null==a||a==[]?await updateDoc(n,{sentRequests:[i]}):(a.push(i),await updateDoc(n,{sentRequests:a}));let s=await getDoc(doc(db,"users",i)).then(e=>e.data().requests);n=s=null==s?[]:s;n.push(auth.currentUser.uid),await updateDoc(doc(db,"users",i),{requests:n}),e()})}onAuthStateChanged(auth,async t=>{if(null!=document.getElementById("COMMUNITY_PAGE"))if(t)if(t.isAnonymous)location.href="../auth/login.html";else{insertLoadingScreen("content",document.getElementById("content"));try{var n=t.uid,a=doc(db,"users",n),s=(updateLoadingInfo("content","Fetching user data"),await getDoc(a).then(e=>e.exists()?e.data():"UNKNOWN"));await checkVaild(t,s);updateLoadingInfo("content","Loading friend requests (1/3)"),await loadFriendRequests(s),updateLoadingInfo("content","Loading send requests (2/3)"),await loadSentRequests(s),updateLoadingInfo("content","Loading friends (3/3)"),await loadFriends();let e=new URLSearchParams(document.location.search);(async()=>{null!=e.get("friend")&&(null!=s.friends&&s.friends.includes(e.get("friend"))?document.getElementById("friendresult").innerHTML=`
                <h1><i class="fa-light fa-check fa-lg"></i> Already friends!</h1>
                <form method="dialog">
                    <button class="puffy_button primary">Ok</button>
                </form>
            `:null!=s.friends&&s.sentRequests.includes(e.get("friend"))?document.getElementById("friendresult").innerHTML=`
                <h1><i class="fa-light fa-check fa-lg"></i> Already sent a request!</h1>
                <form method="dialog">
                    <button class="puffy_button primary">Ok</button>
                </form>
            `:(document.getElementById("friendprocessing").showModal(),await sendRequest(e.get("friend")),document.getElementById("friendprocessing").close()),document.getElementById("friendresult").showModal())})(),null!=e.get("friend")&&(console.log("rwarawr"),window.history.pushState({page:location.pathname},document.title,window.location.pathname)),document.getElementById("friendSearch").addEventListener("change",()=>{var t=document.getElementById("allFriends").children;for(let e=0;e<t.length;e++)t[e].style.display="none";for(let e=0;e<t.length;e++)t[e].id.includes(document.getElementById("friendSearch").value)&&(t[e].style.display="flex")}),updateLoadingInfo("content","Wrapping up"),0==await limitReached(friendlgtnh)&&(document.getElementById("addfriend").addEventListener("click",()=>{document.getElementById("findfriend").showModal()}),document.getElementById("sendrequest").addEventListener("click",async()=>{document.getElementById("sendrequest").innerHTML="Working...",document.getElementById("sendrequest").setAttribute("disabled",""),await sendRequest(""),location.reload()})),document.getElementById("searchFriends").addEventListener("click",()=>{document.getElementById("searchuser").showModal()}),document.getElementById("searchusers").addEventListener("click",async()=>{var n=await searchUsers(document.getElementById("searchfriend").value);document.getElementById("allsearched").innerHTML="";for(let t=0;t<n.length;t++){var a=n[t].data();let e=n[t].id;console.log(a);var s=document.getElementById("queryedex").cloneNode(!0),i=(s.id="",s.children[0]),d=(i.children[0].src=null==a.profileBlue?"../asset/char/blue_notexture.png":"../asset/char/"+a.profileBlue,i.children[1]),r=(d.children[0].innerText=a.username,await FirebaseHelper.getBadges(e));console.log(r);for(let e=0;e<r.length;e++){var o=r[e],l=document.createElement("img");l.src="../asset/badges/"+o.replace(" ","")+".png",l.width="24",l.alt=o,"Bluekid Plus"==(l.title=o)&&l.classList.add("badge--bkp"),d.children[1].append(l)}i=s.children[1];i.children[0].addEventListener("click",()=>{document.getElementById("friendid").value=e,document.getElementById("searchuser").close()}),i.children[1].href="./user/index.html?id="+e,document.getElementById("allsearched").append(s)}})}catch(e){updateLoadingInfo("content","Error: "+e)}finishLoading("content")}else location.href="../auth/login.html"});class CommunityUtilites{static async acceptFriendReq(n,a){return new Promise(async(e,t)=>{await updateFriends(n.uid,a),e()})}static async ignoreFriendReq(e,t){return new Promise(async(e,t)=>{var n=doc(db,"users",request),a=[],n=((a=(await getDoc(n).then(e=>e.data())).sentRequests).splice(a.indexOf(request),1),await updateDoc(n,{sentRequests:a}),doc(db,"users",auth.currentUser.uid)),a=[];(a=(await getDoc(n).then(e=>e.data())).requests).splice(a.indexOf(request),1),await updateDoc(n,{requests:a}),e()})}static async getAllRequests(n){return new Promise(async(e,t)=>{e((await getDoc(doc(db,"users",n.uid))).data().requests)})}}export{CommunityUtilites};