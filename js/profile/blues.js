import{onAuthStateChanged,auth,db,doc,getDoc,getDocs,updateDoc,deleteDoc,signOut,collection,insertLoadingScreen,updateLoadingInfo,finishLoading,increment,onSnapshot}from"../util/firebase.js";let pack_data=null,_data=await fetch("../../asset/blues.json");pack_data=await _data.json();import{isUserVaild,UserReasons}from"../util/auth_helper.js";async function checkVaild(o,d){return new Promise(async(e,t)=>{var n=isUserVaild(o,d);if(n.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(n.reason==UserReasons.BANNED)(a=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(a),a.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(n.reason==UserReasons.TEMPBANNED){var a=document.createElement("dialog"),l=1e3*n.endsOn.seconds,l=new Date(l).getTime();let e=Math.floor((l-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((l-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((l-Date.now())/6e4),t="minutes"),a.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${n.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(a),a.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else n.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}var cachedBlues=null,allAddedSections=[],currentlySelected="",currentAmount=-1;async function getAllUserBlues(l){return new Promise(async(e,t)=>{var n,a;null!=cachedBlues?e(cachedBlues):(n=collection(db,"users",l,"blues"),n=await getDocs(n),a=[],n.forEach(e=>{var t=e.data(),e=e.id;a.push({id:e,data:t})}),e(cachedBlues=a))})}async function updateBluesAmount(a,l){return new Promise(async e=>{document.getElementById("transaction").showModal();var t=0;for(let e=0;e<cachedBlues.length;e++)if(cachedBlues[e].id==a){console.log(cachedBlues[e].data.amount,l),t=cachedBlues[e].data.amount-l,cachedBlues[e].data.amount=t;break}var n=doc(db,"users",auth.currentUser.uid,"blues",currentlySelected);await updateDoc(n,{amount:t}),document.getElementById("preview_amount").innerHTML=t+" Owned",document.getElementById("transaction").close(),e(t)})}function createSection(e,t){var n,a;allAddedSections.includes(e)||allAddedSections.includes("undefined")||(n="undefined",(a=document.createElement("h2")).style.marginTop="5px",null==e||null==pack_data.packs[e]?(a.innerHTML="Bugged Blues",allAddedSections.push("undefined")):(a.innerHTML=pack_data.packs[e].display_name,allAddedSections.push(e),n=e),document.getElementById("allBlues").append(a),(e=document.getElementById("sectex").cloneNode(!0)).id=n,(null!=t?document.getElementById(t):document.getElementById("allBlues")).append(e))}function clickListener(n){n.addEventListener("click",async()=>{if(null!=n.getAttribute("given")){currentlySelected=n.id,document.getElementById("sell").innerHTML='<i class="fa-light fa-coins"></i> Sell',null==pack_data.blues[n.id]?(document.getElementById("preview_img").src="../asset/char/blue_broken.png",document.getElementById("sell").innerHTML="Remove"):document.getElementById("preview_img").src="../asset/char/"+pack_data.blues[n.id].imgPath,document.getElementById("preview_name").innerHTML=n.id;var t=await getAllUserBlues(auth.currentUser.uid);for(let e=0;e<t.length;e++)if(t[e].id==n.id){console.log(t[e]),document.getElementById("preview_amount").innerHTML=t[e].data.amount+" Owned",currentAmount=t[e].data.amount;break}}})}function getPriceFromRarity(e){switch(e.toLocaleLowerCase()){case"common":return 2;case"uncommon":return 5;case"rare":return 25;case"epic":return 50;case"lengendary":return 75;case"mystical":return 200}}function resetPreview(){currentlySelected="",currentAmount=0,document.getElementById("preview_name").innerHTML="None selected.",document.getElementById("preview_amount").innerHTML="0 Owned",document.getElementById("preview_img").src="../asset/char/blue_notexture.png"}let coins,listener;function sellBluePopup(){var e=pack_data.blues[currentlySelected];if(null==e)return""==currentlySelected?void document.getElementById("bugged").showModal():(document.getElementById("removename").innerText=currentlySelected,document.getElementById("removeamount").innerHTML=currentAmount,void document.getElementById("removeblue").showModal());null!=listener&&document.getElementById("sell_amount").removeEventListener("input",listener);let t=getPriceFromRarity(e.rarity);console.log(currentlySelected,e),document.getElementById("sell_name").innerHTML=currentlySelected,listener=()=>{document.getElementById("newCoinAmount").innerHTML=(coins+t*parseInt(document.getElementById("sell_amount").value)).toLocaleString()},document.getElementById("sell_amount").addEventListener("input",listener),document.getElementById("sell_amount").max=currentAmount,document.getElementById("sell_amount").value="1",document.getElementById("sellblue").showModal()}async function sellBlue(){var e,t=getPriceFromRarity(pack_data.blues[currentlySelected].rarity),n=parseInt(document.getElementById("sell_amount").value);0==n?showNotification(3,"Canceled sell."):"NaN"==n.toString()?showNotification(3,"Can't sell NaN blues"):(e=doc(db,"users",auth.currentUser.uid),await updateDoc(e,{tokens:increment(t*n)}),0==await updateBluesAmount(currentlySelected,n)&&(document.getElementById(currentlySelected).removeAttribute("given"),resetPreview()))}onAuthStateChanged(auth,async e=>{if(e)if(e.isAnonymous)location.href="../auth/login.html";else{if("profile"==new URLSearchParams(location.search).get("function")){var t=e.uid,a=doc(db,"users",t),n=(document.getElementById("content").style.display="none",document.getElementById("profile").style.display="block",document.getElementById("bottom_inspect").style.display="none",insertLoadingScreen("content",document.getElementById("profile")),pack_data.blues),l=(updateLoadingInfo("content","Inserting blues..."),Object.entries(n).forEach(([e,t])=>{var n=e,e=t;"//"!=n&&(createSection(e.pack,"allBlues__profile"),(t=document.getElementById("bluex").cloneNode(!0)).id=n,null!=pack_data.blues[n])&&(t.children[0].src="../asset/char/"+pack_data.blues[n].imgPath,t.addEventListener("click",async()=>{insertLoadingScreen("updateprofile",document.getElementById("profile")),updateLoadingInfo("updateprofile","Updating document"),await updateDoc(a,{profileBlue:pack_data.blues[n].imgPath}),updateLoadingInfo("updateprofile","Redirecting"),location.replace("./settings.html#sect.community")}),(null==e.pack||null==e.pack||""==e.pack?document.getElementById("undefined"):document.getElementById(e.pack)).append(t))}),await getAllUserBlues(t));for(let e=0;e<l.length;e++){var o,d=l[e].id;(s=l[e].data).amount<=0||("memes"==s.pack&&(s.pack="meme"),null==document.getElementById(d)&&(createSection("undefined","allBlues__profile"),(o=document.getElementById("bluex").cloneNode(!0)).id=d,null==pack_data.blues[d]?o.children[0].src="../asset/char/blue_broken.png":o.children[0].src="../asset/char/"+pack_data.blues[d].imgPath,clickListener(o),document.getElementById("undefined").append(o)),document.getElementById(d.toString()).setAttribute("given",""))}}else{insertLoadingScreen("content",document.getElementById("content"));var t=e.uid,a=doc(db,"users",t),c=(updateLoadingInfo("content","Fetching user data"),await getDoc(a).then(e=>e.exists()?e.data():"UNKNOWN")),n=(await checkVaild(e,c),pack_data.blues),l=(onSnapshot(a,e=>{e.metadata.hasPendingWrites;coins=parseInt(e.data().tokens),document.getElementById("allcoins").innerHTML=parseInt(e.data().tokens).toLocaleString()}),Object.entries(n).forEach(([e,t])=>{var n;"//"!=e&&(createSection(t.pack),(n=document.getElementById("bluex").cloneNode(!0)).id=e,null==pack_data.blues[e]?n.children[0].src="../asset/char/blue_broken.png":n.children[0].src="../asset/char/"+pack_data.blues[e].imgPath,clickListener(n),(null==t.pack||null==t.pack||""==t.pack?document.getElementById("undefined"):document.getElementById(t.pack)).append(n))}),updateLoadingInfo("content","Retriving blues"),await getAllUserBlues(t));for(let e=0;e<l.length;e++){var r,i,u,d=l[e].id,s=l[e].data;if(!(s.amount<=0)){if("memes"==s.pack&&(s.pack="meme"),createSection(s.pack),null!=pack_data.blues[d]){let e="#000000";switch(pack_data.blues[d].rarity.toLocaleLowerCase()){case"common":e="#cfcfcf";break;case"uncommon":e="#0bd900";break;case"rare":e="#0090d9";break;case"epic":e="#ae00ff";break;case"lengendary":e="#ccb800";break;case"mystical":e="#00d0f0","secret"!=pack_data.blues[d].pack&&((r=document.getElementById("wheelex").cloneNode(!0)).id="",i=document.getElementById(d.toString()).getBoundingClientRect(),r.style.right=i.width/2+"px",r.style.left=i.width/2+"px",document.getElementById(d.toString()).append(r))}document.getElementById(d.toString()).style.backgroundColor=e,document.getElementById(d.toString()).style.border="2px solid "+e,document.getElementById(d.toString()).style.boxShadow="0px 0px 10px 2px "+e}null==document.getElementById(d)&&(createSection("undefined"),(u=document.getElementById("bluex").cloneNode(!0)).id=d,null==pack_data.blues[d]?u.children[0].src="../asset/char/blue_broken.png":u.children[0].src="../asset/char/"+pack_data.blues[d].imgPath,clickListener(u),document.getElementById("undefined").append(u)),document.getElementById(d.toString()).setAttribute("given","")}}document.getElementById("sell").addEventListener("click",sellBluePopup),document.getElementById("info").addEventListener("click",()=>{var e,t=pack_data.blues[currentlySelected];(null==t?document.getElementById("bugged"):(e=getPriceFromRarity(t.rarity),document.getElementById("info_icon").src="../asset/char/"+t.imgPath,document.getElementById("info_name").innerHTML=currentlySelected,document.getElementById("info_price").innerHTML=e,document.getElementById("info_rarity").innerHTML=t.rarity,document.getElementById("info_chance").innerHTML=t.chance+"%",document.getElementById("blueInfo"))).showModal()}),document.getElementById("sellbtn").addEventListener("click",sellBlue),document.getElementById("removeblue_confirm").addEventListener("click",async()=>{document.getElementById("removeblue_confirm").innerHTML="Waiting...",document.getElementById("removeblue_confirm").setAttribute("disabled",""),await deleteDoc(doc(db,"users",e.uid,"blues",currentlySelected)),document.getElementById(currentlySelected).remove(),document.getElementById("removeblue").close(),document.getElementById("removeblue_confirm").innerHTML="Remove (x<span id='removeamount'>1</span>)",document.getElementById("removeblue_confirm").removeAttribute("disabled")})}finishLoading("content")}else location.href="../auth/login.html"});