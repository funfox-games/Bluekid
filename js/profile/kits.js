import{onAuthStateChanged,auth,db,doc,getDoc,signOut,getDocs,deleteDoc,setDoc,updateDoc,collection,deleteObject,storageref,storage,listAll,KIT_COVER_LOCATION,query,limit,where,hasBluekidPlus,insertLoadingScreen,finishLoading,updateLoadingInfo}from"../util/firebase.js";import{isUserVaild,UserReasons}from"../util/auth_helper.js";let userData;async function checkVaild(a,s){return new Promise(async(e,t)=>{var i=isUserVaild(a,s);if(i.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(i.reason==UserReasons.BANNED)(n=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${i.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(n),n.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(i.reason==UserReasons.TEMPBANNED){var n=document.createElement("dialog"),o=1e3*i.endsOn.seconds,o=new Date(o).getTime();let e=Math.floor((o-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((o-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((o-Date.now())/6e4),t="minutes"),n.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${i.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(n),n.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else i.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}let cachedkits;function wait(t){return new Promise(e=>{setTimeout(()=>e(),1e3*t)})}function isKitFavorite(e,t){let i=e.favoriteKits;return(i=null!=i&&null!=i?i:[]).includes(t)}let hasLoadedFavorites=!1;async function loadFavorites(d){return new Promise(async(e,t)=>{if(!hasLoadedFavorites){if(null!=d.favoriteKits&&0!=d.favoriteKits.length){document.getElementById("nofavoritekits").remove(),insertLoadingScreen("favorites",document.getElementById("favoriteKits")),updateLoadingInfo("favorites","Retriving favorites"),console.log(d.favoriteKits),hasLoadedFavorites=!0;for(let e=0;e<d.favoriteKits.length;e++){let n=d.favoriteKits[e],o=(updateLoadingInfo("favorites","Retriving favorite #"+(e+1)),await getDoc(doc(db,"kits",n)));if(null!=(o=null!=(o=(o=o.exists()?o:await getDoc(doc(db,"users",auth.currentUser.uid,"kits",n))).data()).ownerUid&&null!=o.ownerUid?(o=await getDoc(doc(db,"users",o.ownerUid,"kits",o.kitId))).data():o)){let t=document.getElementById("example").cloneNode(!0);t.id=n,t.setAttribute("public_kit",!0),t.setAttribute("kit_favorite",!0);var a=t.children[0],s=(console.log(o),null!=o.cover&&(a.children[0].children[0].src=o.cover),a.children[1]),a=(s.children[0].innerText=o.displayname,s.children[1].innerText=o.author,console.log(o),doc(db,"users",o.author)),a=await getDoc(a);switch(s.children[2].innerHTML='<i id="private_indicator" class="fa-light fa-lock"></i> Unshared',o.visibility){case"private":break;case"friends":s.children[2].innerHTML='<i class="fa-light fa-user-group"></i> Friends only';break;case"public":s.children[2].innerHTML='<i class="fa-light fa-globe"></i> Public'}var l=t.children[1];l.children[0].innerHTML='<i class="fa-light fa-eye"></i> View',l.children[0].addEventListener("click",()=>{location.href="./kit/view.html?id="+n});let i=l.children[1];i.addEventListener("mouseup",()=>{document.getElementById("kit_contextmenu").toggleAttribute("show");var e=i.getBoundingClientRect(),t=document.getElementById("kit_contextmenu").getBoundingClientRect();console.log(e,t),document.getElementById("kit_contextmenu").style.left=e.left-155-25+"px",document.getElementById("kit_contextmenu").style.top=e.top+"px",addContextMenuFunctionality(d,n,o)}),t.addEventListener("contextmenu",e=>{t.hasAttribute("disablecontextmenu")||(document.getElementById("kit_contextmenu").style.left=e.pageX+"px",document.getElementById("kit_contextmenu").style.top=e.pageY+"px",document.getElementById("kit_contextmenu").toggleAttribute("show",!0),addContextMenuFunctionality(d,n,o),e.preventDefault())}),a.exists()?s.children[1].innerText=a.data().username:(l.style.fontSize="1.75rem",l.style.textAlign="right",l.innerHTML="This kit is bugged.<br>Upgrade to DATAV2 to repair.",t.setAttribute("disablecontextmenu","true"),s.children[0].innerHTML+=' <i title="The author field is not vaild. This kit is not able to be uploaded online. (To resolve, create a new kit)" class="fa-light fa-globe fa-xs" style="color: #8f0000;"></i>'),o.author!=auth.currentUser.uid&&l.children[1].remove(),document.getElementById("favoritekits").append(t),e==d.favoriteKits.length-1&&finishLoading("favorites")}}}e()}})}function addContextMenuFunctionality(t,n,e){var i=document.getElementById("kit_contextmenu"),o=i.children[0],a=o.children[0],s=o.children[1],o=o.children[2],a=(null!=t.favoriteKits&&t.favoriteKits.includes(n)?a.innerHTML='<i class="fa-solid fa-star"></i>':a.innerHTML='<i class="fa-light fa-star"></i>',a.removeEventListener("mousedown",a.fn),s.removeEventListener("mousedown",s.fn),o.removeEventListener("mousedown",o.fn),a.addEventListener("mousedown",a.fn=async()=>{var e;null!=t.favoriteKits&&t.favoriteKits.includes(n)?((e=t.favoriteKits).splice(e.indexOf(n),1),showNotification(1,"Working..."),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e})):((e=t.favoriteKits||[]).push(n),showNotification(1,"Working..."),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e})),location.reload()}),s.addEventListener("mousedown",s.fn=()=>{navigator.clipboard.writeText("https://bluekid.netlify.app/profile/kit/view?id="+n),showNotification(4,"Copied to clipboard!")}),o.addEventListener("mousedown",o.fn=async()=>{await deleteDoc(doc(db,"users",auth.currentUser.uid,"kits",n)),await deleteDoc(doc(db,"kits",n));var e=storageref(storage,KIT_COVER_LOCATION+"/"+n),t=await listAll(storageref(storage,KIT_COVER_LOCATION));let i=!1;console.log(KIT_COVER_LOCATION+n),t.items.forEach(e=>{e.name==n&&(i=!0,console.log("found"))}),i&&(console.log("hasCover"),await deleteObject(e)),showNotification(4,"Delete success!"),document.getElementById(n).remove()}),i.children[1]),l=i.children[2],i=i.children[3];a.removeEventListener("mousedown",a.fn),l.removeEventListener("mousedown",l.fn),i.removeEventListener("mousedown",i.fn),a.addEventListener("mousedown",a.fn=()=>{location.href="./kit/edit.html?id="+n}),l.addEventListener("mousedown",l.fn=()=>{showNotification(3,"no ("+n+")")}),i.addEventListener("mousedown",i.fn=async()=>{showNotification(3,"waht?? ("+n+")")}),l.style.display="unset",a.style.display="unset",s.style.display="flex",o.style.display="flex",null!=document.getElementById(n).getAttribute("public_kit")&&(l.style.display="none",a.style.display="none",o.style.display="none")}function changeKitVisibility(t){var i=document.getElementsByClassName("kitsection"),n=document.getElementsByClassName("sectionbtn");for(let e=0;e<i.length;e++){var o=i[e];o.style.display="none",o.id==t&&(o.style.display="block")}for(let e=0;e<n.length;e++){var a=n[e];a.className="new_puffy_button sectionbtn",a.id==t+"Btn"&&(a.className="new_puffy_button sectionbtn primary")}}async function addKitElementsBasedOnArray(a){document.getElementById("allpublickits").innerHTML="";for(let o=0;o<a.length;o++){document.getElementById("publicKitsLoading")&&(document.getElementById("publicKitsLoading").innerHTML=`<p style="font-size: 1.75rem;"><i class="fa-light fa-gear fa-spin fa-sm"></i> Loading... (${o+1}/${a.length})</p>`);let e=a[o];var s=document.getElementById("publicexample").cloneNode(!0),l=(s.id=e.kitId,s.children[0]),d=s.children[1],r=await getDoc(doc(db,"users",e.ownerUid));l.getElementsByClassName("publickitimage")[0].src=e.preview.icon,l.getElementsByClassName("kittitle")[0].innerText=e.preview.title,l.getElementsByClassName("kitcreator")[0].innerHTML=`<i class="fa-light fa-users" aria-hidden="true"></i> Created by <a style="color:black;" href="./user/index.html?id=${e.ownerUid}">${r.data().username}</a>`,d.getElementsByClassName("playkit")[0].addEventListener("click",()=>{sessionStorage.setItem("hostkit",e.kitId),sessionStorage.setItem("ownsKit",!1),location.href="../game/host.html"}),d.getElementsByClassName("viewkit")[0].href="./kit/view.html?id="+e.kitId;let t=userData.favoriteKits||[],i=d.getElementsByClassName("favoritekit")[0],n=t.includes(e.kitId);n&&(i.innerHTML='<i class="fa-light fa-star"></i> Favorited'),d.getElementsByClassName("favoritekit")[0].addEventListener("click",async()=>{i.innerHTML="Working...",i.setAttribute("disabled",""),n=n?(t.splice(t.indexOf(e.kitId),1),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:t}),i.innerHTML='<i class="fa-light fa-star"></i> Favorite',i.removeAttribute("disabled"),!1):(t.push(e.kitId),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:t}),i.innerHTML='<i class="fa-light fa-star"></i> Favorited',i.removeAttribute("disabled"),!0)}),document.getElementById("allpublickits").append(s)}}async function search(e){if(0==e.length)console.log("RAWRAWRAWRAWRWARA"),await loadPublicKits();else{document.getElementById("publicKitsLoading").style.display="flex";e=query(collection(db,"kits"),where("preview.title","==",e),limit(10)),e=await getDocs(e);let t=[];e.forEach(e=>{null!=e.data().preview&&"public"==e.data().preview.visibility&&t.push(e.data())}),await addKitElementsBasedOnArray(t),document.getElementById("publicKitsLoading").style.display="none"}}async function loadPublicKits(){document.getElementById("publicKitsLoading").style.display="flex",console.log("Loading public..."),document.getElementById("publicKitsLoading")&&(document.getElementById("publicKitsLoading").innerHTML='<p style="font-size: 1.75rem;"><i class="fa-light fa-gear fa-spin fa-sm"></i> Preforming query...</p>');var e=query(collection(db,"kits"),limit(10)),e=await getDocs(e);let t=[];e.forEach(e=>{null!=e.data().preview&&"public"==e.data().preview.visibility&&t.push(e.data())}),await addKitElementsBasedOnArray(t),document.getElementById("publicKitsLoading").style.display="none"}onAuthStateChanged(auth,async e=>{var t,i;!e||e.isAnonymous?location.href="../auth/login.html":(insertLoadingScreen("content",document.getElementById("normalKits")),t=e.uid,i=doc(db,"users",t),updateLoadingInfo("content","Fetching user data"),await checkVaild(e,userData=await getDoc(i).then(e=>e.exists()?e.data():"UNKNOWN")),e=await collection(db,"users",t,"kits"),updateLoadingInfo("content","Retriving kits"),15<=(i=await getDocs(e)).size&&0==await hasBluekidPlus()&&(document.getElementById("kitamount").innerHTML=i.size,document.getElementById("closeToLimit").setAttribute("show","")),document.getElementById("nokits").remove(),(cachedkits=i).forEach(async e=>{let i=e.data(),n=e.id,t=document.getElementById("example").cloneNode(!0);t.id=n;var e=t.children[0],o=(null!=i.cover&&(e.children[0].children[0].src=i.cover),i.bkpOnly&&e.children[0].children[1].removeAttribute("hide"),e.children[1]),e=(o.children[0].innerText=i.displayname,o.children[1].innerText=i.author,doc(db,"users",i.author)),e=await getDoc(e);switch(isKitFavorite(userData,n)&&t.setAttribute("kit_favorite","true"),o.children[2].innerHTML='<i id="private_indicator" class="fa-light fa-lock"></i> Unshared',i.visibility){case"private":break;case"friends":o.children[2].innerHTML='<i class="fa-light fa-user-group"></i> Friends only';break;case"public":o.children[2].innerHTML='<i class="fa-light fa-globe"></i> Public'}var a=t.children[1];a.children[0].addEventListener("click",()=>{location.href="./kit/edit.html?id="+n});let s=a.children[1];s.addEventListener("mouseup",()=>{document.getElementById("kit_contextmenu").toggleAttribute("show");var e=s.getBoundingClientRect(),t=document.getElementById("kit_contextmenu").getBoundingClientRect();console.log(e,t),document.getElementById("kit_contextmenu").style.left=e.left-155-25+"px",document.getElementById("kit_contextmenu").style.top=e.top+"px",addContextMenuFunctionality(userData,n,i)}),t.addEventListener("contextmenu",e=>{t.hasAttribute("disablecontextmenu")||(document.getElementById("kit_contextmenu").style.left=e.pageX+"px",document.getElementById("kit_contextmenu").style.top=e.pageY+"px",document.getElementById("kit_contextmenu").toggleAttribute("show",!0),addContextMenuFunctionality(userData,n,i),e.preventDefault())}),e.exists()?o.children[1].innerText=e.data().username:(a.style.fontSize="1.75rem",a.style.textAlign="right",a.innerHTML="This kit is bugged.<br>Upgrade to DATAV2 to repair.",t.setAttribute("disablecontextmenu","true"),o.children[0].innerHTML+=' <i title="The author field is not vaild. This kit is not able to be uploaded online. (To resolve, create a new kit)" class="fa-light fa-globe fa-xs" style="color: #8f0000;"></i>'),document.getElementById("kits").append(t)}),document.body.addEventListener("mousedown",()=>{document.getElementById("kit_contextmenu").removeAttribute("show")}),document.getElementById("normalKitsBtn").addEventListener("click",()=>{changeKitVisibility("normalKits")}),document.getElementById("favoriteKitsBtn").addEventListener("click",()=>{changeKitVisibility("favoriteKits"),loadFavorites(userData)}),document.getElementById("searchPublic").addEventListener("change",()=>{console.log(document.getElementById("searchPublic").value),search(document.getElementById("searchPublic").value)}),finishLoading("content"))});