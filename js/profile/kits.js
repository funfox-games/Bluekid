import{onAuthStateChanged,auth,db,doc,getDoc,signOut,getDocs,deleteDoc,setDoc,updateDoc,collection,deleteObject,storageref,storage,listAll,KIT_COVER_LOCATION,query,limit,where,hasBluekidPlus}from"../util/firebase.js";import{isUserVaild,UserReasons}from"../util/auth_helper.js";let userData;async function checkVaild(a,s){return new Promise(async(e,t)=>{var i=isUserVaild(a,s);if(i.reason==UserReasons.OVERDUE)location.href="../auth/overdue.html";else if(i.reason==UserReasons.BANNED)(n=document.createElement("dialog")).innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${i.banReason}</p>
            <br>
            <b>You can resolve this by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(n),n.showModal(),document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"});else if(i.reason==UserReasons.TEMPBANNED){var n=document.createElement("dialog"),o=1e3*i.endsOn.seconds,o=new Date(o).getTime();let e=Math.floor((o-Date.now())/864e5),t="days";console.log(e),0==e&&(e=Math.floor((o-Date.now())/36e5),t="hours",0==e)&&(e=Math.floor((o-Date.now())/6e4),t="minutes"),n.innerHTML=`
            <h1>You're banned.</h1>
            <p>Reason: ${i.banReason}</p>
            <p>Ends in ${e} ${t}.</p>
            <br>
            <b>You can resolve this sooner by contacting the developer.</b>
            <button class="puffy_button danger" id="logout__ban">Logout</button>
        `,document.body.append(n),n.showModal(),void document.getElementById("logout__ban").addEventListener("click",async()=>{await signOut(auth),location.href="../index.html"})}else i.reason==UserReasons.OTHER&&showNotification(3,"Something went wrong checking user info. Continuing as normal."),e()})}let cachedkits;function wait(t){return new Promise(e=>{setTimeout(()=>e(),1e3*t)})}function isKitFavorite(e,t){let i=e.favoriteKits;return(i=null!=i&&null!=i?i:[]).includes(t)}async function loadFavorites(r){return new Promise(async(e,t)=>{null!=r.favoriteKits&&null!=r.favoriteKits&&0!=r.favoriteKits.length||(showNotification(2,"You have no favorite kits."),e());for(let e=0;e<r.favoriteKits.length;e++){let a=r.favoriteKits[e];if(null==document.getElementById(a)){let o=await getDoc(doc(db,"kits",a));if(null!=(o=null!=(o=(o=o.exists()?o:await getDoc(doc(db,"users",auth.currentUser.uid,"kits",a))).data()).ownerUid&&null!=o.ownerUid?(o=await getDoc(doc(db,"users",o.ownerUid,"kits",o.kitId))).data():o)){let t=document.getElementById("example").cloneNode(!0);t.id=a,t.setAttribute("public_kit",!0),t.setAttribute("kit_favorite",!0);var s=t.children[0],l=(console.log(o),null!=o.cover&&(s.children[0].children[0].src=o.cover),s.children[1]),s=(l.children[0].innerText=o.displayname,l.children[1].innerText=o.author,console.log(o),doc(db,"users",o.author)),s=await getDoc(s);switch(l.children[2].innerHTML='<i id="private_indicator" class="fa-solid fa-lock"></i> Unshared',o.visibility){case"private":break;case"friends":l.children[2].innerHTML='<i class="fa-solid fa-user-group"></i> Friends only';break;case"public":l.children[2].innerHTML='<i class="fa-solid fa-globe"></i> Public'}let i=t.children[1],n=(i.children[0].addEventListener("click",()=>{sessionStorage.setItem("hostkit",a),sessionStorage.setItem("ownsKit",!1),location.href="../game/host.html"}),i.children[1].addEventListener("click",()=>{location.href="./kit/edit.html?id="+a}),i.children[2].addEventListener("click",async()=>{i.children[2].innerHTML='<i class="fa-solid fa-gear fa-spin"></i> Working...',i.children[2].setAttribute("disabled","");var e=doc(db,"kits",a);await setDoc(e,{kitId:a,ownerUid:auth.currentUser.uid}),document.getElementById("publishedKit").showModal(),document.getElementById("share_kit").removeEventListener("click",document.getElementById("share_kit").fn),document.getElementById("share_kit").addEventListener("click",document.getElementById("share_kit").fn=()=>{navigator.clipboard.writeText("https://bluekid.netlify.app/profile/kit/view?id="+a),showNotification(4,"Copied to clipboard!")}),i.children[2].remove()}),i.children[3]);n.addEventListener("mouseup",()=>{document.getElementById("kit_contextmenu").toggleAttribute("show");var e=n.getBoundingClientRect(),t=document.getElementById("kit_contextmenu").getBoundingClientRect();console.log(e,t),document.getElementById("kit_contextmenu").style.left=e.left-155-25+"px",document.getElementById("kit_contextmenu").style.top=e.top+"px",addContextMenuFunctionality(r,a,o)});var d=await getDoc(doc(db,"kits",a));("private"==o.visibility||d.exists())&&i.children[2].remove(),t.addEventListener("contextmenu",e=>{t.hasAttribute("disablecontextmenu")||(document.getElementById("kit_contextmenu").style.left=e.pageX+"px",document.getElementById("kit_contextmenu").style.top=e.pageY+"px",document.getElementById("kit_contextmenu").toggleAttribute("show",!0),addContextMenuFunctionality(r,a,o),e.preventDefault())}),s.exists()?l.children[1].innerText=s.data().username:(i.style.fontSize="1.75rem",i.style.textAlign="right",i.innerHTML="This kit is bugged.<br>Upgrade to DATAV2 to repair.",t.setAttribute("disablecontextmenu","true"),l.children[0].innerHTML+=' <i title="The author field is not vaild. This kit is not able to be uploaded online. (To resolve, create a new kit)" class="fa-solid fa-globe fa-xs" style="color: #8f0000;"></i>'),o.author!=auth.currentUser.uid&&i.children[1].remove(),document.getElementById("kits").append(t)}}}e()})}async function filterChange(e,t){var i=document.getElementById("kits").children;for(let e=0;e<i.length;e++){var n=i[e];"example"==n.id||null!=n.getAttribute("public_kit")?n.style.display="none":n.style.display="flex"}if(e){document.getElementById("loadingfavs").style.display="flex",await loadFavorites(t),document.getElementById("loadingfavs").style.display="none";var o=document.getElementById("kits").children;for(let e=0;e<o.length;e++){var a=o[e];a.style.display="none",null!=a.getAttribute("kit_favorite")&&(a.style.display="flex")}}}function addContextMenuFunctionality(t,n,e){var i=document.getElementById("kit_contextmenu"),o=i.children[0],a=o.children[0],s=o.children[1],o=o.children[2],a=(t.favoriteKits.includes(n)?a.innerHTML='<i class="fa-solid fa-star"></i>':a.innerHTML='<i class="fa-regular fa-star"></i>',a.removeEventListener("mousedown",a.fn),s.removeEventListener("mousedown",s.fn),o.removeEventListener("mousedown",o.fn),a.addEventListener("mousedown",a.fn=async()=>{var e;t.favoriteKits.includes(n)?((e=t.favoriteKits).splice(e.indexOf(n),1),showNotification(1,"Working..."),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e})):((e=t.favoriteKits).push(n),showNotification(1,"Working..."),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:e})),location.reload()}),s.addEventListener("mousedown",s.fn=()=>{navigator.clipboard.writeText("https://bluekid.netlify.app/profile/kit/view?id="+n),showNotification(4,"Copied to clipboard!")}),o.addEventListener("mousedown",o.fn=async()=>{await deleteDoc(doc(db,"users",auth.currentUser.uid,"kits",n)),await deleteDoc(doc(db,"kits",n));var e=storageref(storage,KIT_COVER_LOCATION+"/"+n),t=await listAll(storageref(storage,KIT_COVER_LOCATION));let i=!1;console.log(KIT_COVER_LOCATION+n),t.items.forEach(e=>{e.name==n&&(i=!0,console.log("found"))}),i&&(console.log("hasCover"),await deleteObject(e)),showNotification(4,"Delete success!"),document.getElementById(n).remove()}),i.children[1]),l=i.children[2],i=i.children[3];a.removeEventListener("mousedown",a.fn),l.removeEventListener("mousedown",l.fn),i.removeEventListener("mousedown",i.fn),a.addEventListener("mousedown",a.fn=()=>{location.href="./kit/edit.html?id="+n}),l.addEventListener("mousedown",l.fn=()=>{showNotification(3,"no ("+n+")")}),i.addEventListener("mousedown",i.fn=async()=>{showNotification(3,"waht?? ("+n+")")}),l.style.display="unset",a.style.display="unset",s.style.display="flex",o.style.display="flex",null!=document.getElementById(n).getAttribute("public_kit")&&(l.style.display="none",a.style.display="none",o.style.display="none")}function changeKitVisibility(e){document.getElementById("publicKits").style.display="none",document.getElementById("normalKits").style.display="none",document.getElementById("publicKitsBtn").removeAttribute("disabled"),document.getElementById("normalKitsBtn").removeAttribute("disabled"),document.getElementById(e+"Btn").setAttribute("disabled",!0),document.getElementById(e).style.display="block"}async function addKitElementsBasedOnArray(a){document.getElementById("allpublickits").innerHTML="";for(let o=0;o<a.length;o++){document.getElementById("publicKitsLoading")&&(document.getElementById("publicKitsLoading").innerHTML=`<p style="font-size: 1.75rem;"><i class="fa-solid fa-gear fa-spin fa-sm"></i> Loading... (${o+1}/${a.length})</p>`);let e=a[o];var s=document.getElementById("publicexample").cloneNode(!0),l=(s.id=e.kitId,s.children[0]),d=s.children[1],r=await getDoc(doc(db,"users",e.ownerUid));l.getElementsByClassName("publickitimage")[0].src=e.preview.icon,l.getElementsByClassName("kittitle")[0].innerText=e.preview.title,l.getElementsByClassName("kitcreator")[0].innerHTML=`<i class="fa-solid fa-users" aria-hidden="true"></i> Created by <a style="color:black;" href="./user/index.html?id=${e.ownerUid}">${r.data().username}</a>`,d.getElementsByClassName("playkit")[0].addEventListener("click",()=>{sessionStorage.setItem("hostkit",e.kitId),sessionStorage.setItem("ownsKit",!1),location.href="../game/host.html"}),d.getElementsByClassName("viewkit")[0].href="./kit/view.html?id="+e.kitId;let t=userData.favoriteKits||[],i=d.getElementsByClassName("favoritekit")[0],n=t.includes(e.kitId);n&&(i.innerHTML='<i class="fa-solid fa-star"></i> Favorited'),d.getElementsByClassName("favoritekit")[0].addEventListener("click",async()=>{i.innerHTML="Working...",i.setAttribute("disabled",""),n=n?(t.splice(t.indexOf(e.kitId),1),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:t}),i.innerHTML='<i class="fa-regular fa-star"></i> Favorite',i.removeAttribute("disabled"),!1):(t.push(e.kitId),await updateDoc(doc(db,"users",auth.currentUser.uid),{favoriteKits:t}),i.innerHTML='<i class="fa-solid fa-star"></i> Favorited',i.removeAttribute("disabled"),!0)}),document.getElementById("allpublickits").append(s)}}async function search(e){if(0==e.length)console.log("RAWRAWRAWRAWRWARA"),await loadPublicKits();else{document.getElementById("publicKitsLoading").style.display="flex";e=query(collection(db,"kits"),where("preview.title","==",e),limit(10)),e=await getDocs(e);let t=[];e.forEach(e=>{null!=e.data().preview&&"public"==e.data().preview.visibility&&t.push(e.data())}),await addKitElementsBasedOnArray(t),document.getElementById("publicKitsLoading").style.display="none"}}async function loadPublicKits(){document.getElementById("publicKitsLoading").style.display="flex",console.log("Loading public..."),document.getElementById("publicKitsLoading")&&(document.getElementById("publicKitsLoading").innerHTML='<p style="font-size: 1.75rem;"><i class="fa-solid fa-gear fa-spin fa-sm"></i> Preforming query...</p>');var e=query(collection(db,"kits"),limit(10)),e=await getDocs(e);let t=[];e.forEach(e=>{null!=e.data().preview&&"public"==e.data().preview.visibility&&t.push(e.data())}),await addKitElementsBasedOnArray(t),document.getElementById("publicKitsLoading").style.display="none"}onAuthStateChanged(auth,async e=>{var t,i;e?(t=e.uid,i=doc(db,"users",t),await checkVaild(e,userData=await getDoc(i).then(e=>e.exists()?e.data():"UNKNOWN")),e=await collection(db,"users",t,"kits"),1!=(i=await getDocs(e)).empty&&(15<=i.size&&0==await hasBluekidPlus()&&(document.getElementById("kitamount").innerHTML=i.size,document.getElementById("closeToLimit").setAttribute("show","")),document.getElementById("nokits").remove(),(cachedkits=i).forEach(async e=>{let i=e.data(),n=e.id,t=document.getElementById("example").cloneNode(!0);t.id=n;var e=t.children[0],o=(null!=i.cover&&(e.children[0].children[0].src=i.cover),e.children[1]),e=(o.children[0].innerText=i.displayname,o.children[1].innerText=i.author,doc(db,"users",i.author)),e=await getDoc(e);switch(isKitFavorite(userData,n)&&t.setAttribute("kit_favorite","true"),o.children[2].innerHTML='<i id="private_indicator" class="fa-solid fa-lock"></i> Unshared',i.visibility){case"private":break;case"friends":o.children[2].innerHTML='<i class="fa-solid fa-user-group"></i> Friends only';break;case"public":o.children[2].innerHTML='<i class="fa-solid fa-globe"></i> Public'}let a=t.children[1],s=(a.children[0].addEventListener("click",()=>{sessionStorage.setItem("hostkit",n),sessionStorage.setItem("ownsKit",!0),location.href="../game/host.html"}),a.children[1].addEventListener("click",()=>{location.href="./kit/edit.html?id="+n}),a.children[2].addEventListener("click",async()=>{a.children[2].innerHTML='<i class="fa-solid fa-gear fa-spin"></i> Working...',a.children[2].setAttribute("disabled","");var e=doc(db,"kits",n);await setDoc(e,{kitId:n,ownerUid:auth.currentUser.uid}),document.getElementById("publishedKit").showModal(),document.getElementById("share_kit").removeEventListener("click",document.getElementById("share_kit").fn),document.getElementById("share_kit").addEventListener("click",document.getElementById("share_kit").fn=()=>{navigator.clipboard.writeText("https://bluekid.netlify.app/profile/kit/view?id="+n),showNotification(4,"Copied to clipboard!")}),a.children[2].remove()}),a.children[3]);s.addEventListener("mouseup",()=>{document.getElementById("kit_contextmenu").toggleAttribute("show");var e=s.getBoundingClientRect(),t=document.getElementById("kit_contextmenu").getBoundingClientRect();console.log(e,t),document.getElementById("kit_contextmenu").style.left=e.left-155-25+"px",document.getElementById("kit_contextmenu").style.top=e.top+"px",addContextMenuFunctionality(userData,n,i)});var l=await getDoc(doc(db,"kits",n));"private"!=i.visibility&&!l.exists()||a.children[2].remove(),t.addEventListener("contextmenu",e=>{t.hasAttribute("disablecontextmenu")||(document.getElementById("kit_contextmenu").style.left=e.pageX+"px",document.getElementById("kit_contextmenu").style.top=e.pageY+"px",document.getElementById("kit_contextmenu").toggleAttribute("show",!0),addContextMenuFunctionality(userData,n,i),e.preventDefault())}),e.exists()?o.children[1].innerText=e.data().username:(a.style.fontSize="1.75rem",a.style.textAlign="right",a.innerHTML="This kit is bugged.<br>Upgrade to DATAV2 to repair.",t.setAttribute("disablecontextmenu","true"),o.children[0].innerHTML+=' <i title="The author field is not vaild. This kit is not able to be uploaded online. (To resolve, create a new kit)" class="fa-solid fa-globe fa-xs" style="color: #8f0000;"></i>'),document.getElementById("kits").append(t)}),document.body.addEventListener("mousedown",()=>{document.getElementById("kit_contextmenu").removeAttribute("show")}),document.getElementById("favorites").addEventListener("change",()=>{filterChange(document.getElementById("favorites").checked,userData)}),document.getElementById("normalKitsBtn").addEventListener("click",()=>{changeKitVisibility("normalKits")}),document.getElementById("publicKitsBtn").addEventListener("click",()=>{changeKitVisibility("publicKits"),loadPublicKits()}),document.getElementById("searchPublic").addEventListener("change",()=>{console.log(document.getElementById("searchPublic").value),search(document.getElementById("searchPublic").value)})),document.getElementById("loading").style.display="none"):location.href="../auth/login.html"});