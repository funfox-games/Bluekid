import{onAuthStateChanged,auth,getDoc,doc,db,FirebaseHelper,ONLINE_TEXT,OFFLINE_TEXT,collection,getDocs,query,where,updateDoc}from"../util/firebase.js";let blue_data=null,_data=await fetch("../../asset/blues.json");async function checkImage(i){return new Promise((e,t)=>{var n=new Image;n.onload=function(){0<this.width&&e(!0)},n.onerror=function(){e(!1)},n.src=i})}function updatePrivacy(e,t){switch(t.showBlues){case"none":document.getElementById("blues").setAttribute("locked","privacy"),document.getElementById("blues").innerHTML=`
            <div class="container" style="background-color: #0000001f;font-size:18px;">
                <i class="fa-solid fa-shield-halved fa-xl"></i>
                This section is protected.
            </div>
            `;break;case"friends":e.data().friends.includes(auth.currentUser.uid)||(document.getElementById("blues").setAttribute("locked","privacy"),document.getElementById("blues").innerHTML=`
                <div class="container" style="background-color: #0000001f;font-size:18px;">
                    <i class="fa-solid fa-shield-halved fa-xl"></i>
                    This section is protected.
                </div>
                `)}switch(t.showGameHistory){case"none":document.getElementById("gameHistory").setAttribute("locked","privacy"),document.getElementById("gameHistory").innerHTML=`
            <div class="container" style="background-color: #0000001f;font-size:18px;">
                <i class="fa-solid fa-shield-halved fa-xl"></i>
                This section is protected.
            </div>
            `;break;case"friends":e.data().friends.includes(auth.currentUser.uid)||(document.getElementById("gameHistory").setAttribute("locked","privacy"),document.getElementById("gameHistory").innerHTML=`
                <div class="container" style="background-color: #0000001f;font-size:18px;">
                    <i class="fa-solid fa-shield-halved fa-xl"></i>
                    This section is protected.
                </div>
                `)}switch(t.showKits){case"none":document.getElementById("kits").setAttribute("locked","privacy"),document.getElementById("kits").innerHTML=`
            <div class="container" style="background-color: #0000001f;font-size:18px;">
                <i class="fa-solid fa-shield-halved fa-xl"></i>
                This section is protected.
            </div>
            `;break;case"friends":e.data().friends.includes(auth.currentUser.uid)||(document.getElementById("kits").setAttribute("locked","privacy"),document.getElementById("kits").innerHTML=`
                <div class="container" style="background-color: #0000001f;font-size:18px;">
                    <i class="fa-solid fa-shield-halved fa-xl"></i>
                    This section is protected.
                </div>
                `)}switch(t.showStatus){case"none":document.getElementById("status_container").setAttribute("locked","privacy"),document.getElementById("status_container").innerHTML=`
            <div class="container" style="background-color: #0000001f;font-size:18px;">
                <i class="fa-solid fa-shield-halved fa-xl"></i>
                This section is protected.
            </div>
            `;break;case"friends":e.data().friends.includes(auth.currentUser.uid)||(document.getElementById("status_container").setAttribute("locked","privacy"),document.getElementById("status_container").innerHTML=`
                <div class="container" style="background-color: #0000001f;font-size:18px;">
                    <i class="fa-solid fa-shield-halved fa-xl"></i>
                    This section is protected.
                </div>
                `)}switch(t.showLastOnline){case"none":"none"!=t.showStatus&&null!=document.getElementById("lastonline")&&(document.getElementById("lastonline").parentElement.setAttribute("locked","privacy"),document.getElementById("lastonline").parentElement.innerHTML=`
            <div class="container" style="background-color: #0000001f;font-size:18px;">
                <i class="fa-solid fa-shield-halved fa-xl"></i>
                Last online is protected.
            </div>
            `);break;case"friends":if(!e.data().friends.includes(auth.currentUser.uid)){if("friends"==t.showStatus)break;document.getElementById("lastonline").parentElement.setAttribute("locked","privacy"),document.getElementById("lastonline").parentElement.innerHTML=`
                <div class="container" style="background-color: #0000001f;font-size:18px;">
                    <i class="fa-solid fa-shield-halved fa-xl"></i>
                    Last online is protected.
                </div>
                `}}}async function loadBadges(e){var t=await FirebaseHelper.getBadges(e);for(let e=0;e<t.length;e++){var n=t[e],i=document.getElementById("badgeex").cloneNode(!0),n=(i.id="",(i.title=n).replace(" ",""));i.children[0].src=`../../asset/badges/${n}.png`,"BluekidPlus"==n&&i.classList.add("badge--bkp"),document.getElementById("badges").appendChild(i)}}async function loadBlues(e){e=collection(db,"users",e,"blues");(await getDocs(e)).forEach(e=>{var t=e.data(),e=e.id,n=blue_data.blues[e],i=document.getElementById("blue_ex").cloneNode(!0);i.id="";let d;null==n?(d="blue_broken.png",i.title=e+": Bugged"):(d=n.imgPath,i.title=`${e}: ${n.rarity} (${t.amount} Owned)`),i.children[0].src="../../asset/char/"+d,document.getElementById("blues").append(i)})}async function loadKits(e){e=collection(db,"users",e,"kits"),e=query(e,where("visibility","==","public"));(await getDocs(e)).forEach(e=>{var t=e.id,e=e.data(),n=document.getElementById("kitex").cloneNode(!0),i=(n.id=t,n.children[0]),d=n.children[1];i.children[0].children[0].src=e.cover,i.children[1].children[0].innerText=e.displayname,i.children[1].children[1].innerHTML='<i class="fa-solid fa-globe"></i> Public',d.children[0].href=location.origin+"/profile/kit/view.html?id="+t,document.getElementById("kits").append(n)})}async function showFriendedKits(e){e=collection(db,"users",e,"kits"),e=query(e,where("visibility","!=","private"));(await getDocs(e)).forEach(e=>{var t=e.id,e=e.data(),n=document.getElementById("kitex").cloneNode(!0),i=(n.id=t,n.children[0]),d=n.children[1];i.children[0].children[0].src=e.cover,i.children[1].children[0].innerText=e.displayname,i.children[1].children[1].innerHTML='<i class="fa-solid fa-globe"></i> Public',d.children[0].href=location.origin+"/profile/kit/view.html?id="+t,document.getElementById("kits").append(n)})}blue_data=await _data.json(),onAuthStateChanged(auth,async i=>{let a=new URL(location).searchParams.get("id");var l=await getDoc(doc(db,"users",a));if(a==i.uid&&(document.getElementById("yourprofile").style.display="block",document.getElementById("addfriend").style.display="none"),l.exists()){document.getElementById("loading").showModal();var e=l.data().communitySettings;let t="friends";var o;let n="all";var r,c;null!=e&&(t=e.privacy.showBlues,o=e.privacy.showGameHistory,n=e.privacy.showKits,r=e.privacy.hideTokens,c=e.privacy.showStatus,e=e.privacy.showLastOnline,auth.currentUser.uid!=a)&&updatePrivacy(l,{showBlues:t,showGameHistory:o,showKits:n,hideTokens:r,showStatus:c,showLastOnline:e});try{document.getElementById("loading_progress").innerHTML="user data";var u=i.uid,m=doc(db,"users",u),g=await getDoc(m).then(e=>e.exists()?e.data():"UNKNOWN"),y=null!=g.friends&&g.friends.includes(a),f=(document.getElementById("loading_progress").innerHTML="badges",await loadBadges(a),document.getElementById("loading_progress").innerHTML="blues","all"==t&&await loadBlues(a),"friends"==t&&y&&await loadBlues(a),document.getElementById("loading_progress").innerHTML="kits","all"==n&&await loadKits(a),"friends"==n&&y&&await showFriendedKits(a),null!=l.data().friends&&(document.getElementById("friendAmount").innerHTML=l.data().friends.length),document.getElementById("loading_progress").innerHTML="metadata",await FirebaseHelper.getUserMetadata(a)),h=new Date(f.createdOn),p=Date.parse(h)-new Date,E=-Math.floor(p/864e5),B=(document.getElementById("joinned").innerHTML=E,y&&(document.getElementById("addfriend").style.display="none",document.getElementById("removefriend").style.display="unset"),l.data());null!=B.profileSettings&&(document.body.style.backgroundImage=`linear-gradient(${B.profileSettings.primaryColor}, ${B.profileSettings.secondaryColor})`),document.getElementById("username").innerText=B.username,document.getElementById("uid").innerHTML=a,document.getElementById("addfriend").href="../community.html?friend="+a,document.getElementById("loading_progress").innerHTML="user status";let e=await FirebaseHelper.getUserStatus(a);document.getElementById("status")&&(document.getElementById("status").innerHTML=e.status),e.status==ONLINE_TEXT&&null==document.getElementById("status_container").getAttribute("locked")?(document.getElementById("online").style.display="unset",document.getElementById("status_container").classList.add("online")):e.status==OFFLINE_TEXT&&null==document.getElementById("status_container").getAttribute("locked")&&(document.getElementById("offline").style.display="unset"),document.getElementById("loading_progress").innerHTML="profile picture",await checkImage(f.photoURL)&&(document.getElementById("pfp").src=f.photoURL)}catch(e){alert("Loading error: "+e),console.error("ERROR: ",e),alert("Please either refresh or post a new issue in the Home page.")}document.getElementById("loading").close();let s=await FirebaseHelper.getUserStatus(a),d=(setInterval(async()=>{var e=-(Date.parse(s.lastOnline)-new Date),t=Math.floor(e/1e3),n=Math.floor(e/6e4),i=Math.floor(e/864e5),d=Math.floor(e/36e5),a=Math.floor(e/6048e5),e=Math.floor(e/2628e6);null!=document.getElementById("lastonline")&&(0<e?document.getElementById("lastonline").innerHTML=e+" month"+(1==e?"":"s"):0<a?document.getElementById("lastonline").innerHTML=a+" week"+(1==a?"":"s"):0<i?document.getElementById("lastonline").innerHTML=i+" day"+(1==i?"":"s"):0<d?document.getElementById("lastonline").innerHTML=d+" hour"+(1==d?"":"s"):0<n?document.getElementById("lastonline").innerHTML=n+" minute"+(1==n?"":"s"):0<t&&(document.getElementById("lastonline").innerHTML=t+" second"+(1==t?"":"s")))},100),null==s.lastOnline&&(document.getElementById("lastonline").parentElement.style.display="none"),document.getElementById("share").addEventListener("click",()=>{navigator.clipboard.writeText(location.toString()),showNotification(4,"Copied to clipboard!")}),document.getElementById("removefriend").innerHTML);document.getElementById("removefriend").addEventListener("click",async()=>{var e=doc(db,"users",auth.currentUser.uid),t=doc(db,"users",a);document.getElementById("removefriend").innerHTML="Waiting...",document.getElementById("removefriend").setAttribute("disabled","");let n=[];var i=await getDoc(e).then(e=>e.data()),i=((n=i.friends).splice(n.indexOf(a),1),await updateDoc(e,{friends:n}),n=[],await getDoc(t).then(e=>e.data()));(n=i.friends).splice(n.indexOf(a),1),await updateDoc(t,{friends:n}),document.getElementById("addfriend").style.display="unset",document.getElementById("removefriend").style.display="none",document.getElementById("removefriend").innerHTML=d,document.getElementById("removefriend").removeAttribute("disabled")})}});