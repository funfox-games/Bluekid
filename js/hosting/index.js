import{auth,collection,db,doc,finishLoading,getDoc,getDocs,hasBluekidPlus,HOSTING_VERSION,insertLoadingScreen,onAuthStateChanged}from"../util/firebase.js";class BubbleSwitch{static toOne(){document.getElementsByClassName("progress")[0].children[0].setAttribute("done",""),document.getElementsByClassName("progress")[0].children[1].setAttribute("progressed","")}static toTwo(){document.getElementsByClassName("progress")[0].children[1].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[1].setAttribute("done",""),document.getElementsByClassName("progress")[0].children[2].setAttribute("done",""),document.getElementsByClassName("progress")[0].children[3].setAttribute("progressed","")}static toThree(){document.getElementsByClassName("progress")[0].children[3].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[3].setAttribute("done",""),document.getElementsByClassName("progress")[0].children[4].setAttribute("done","")}static reset(){document.getElementsByClassName("progress")[0].children[0].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[0].removeAttribute("done"),document.getElementsByClassName("progress")[0].children[1].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[1].removeAttribute("done"),document.getElementsByClassName("progress")[0].children[2].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[2].removeAttribute("done"),document.getElementsByClassName("progress")[0].children[3].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[3].removeAttribute("done"),document.getElementsByClassName("progress")[0].children[4].removeAttribute("progressed"),document.getElementsByClassName("progress")[0].children[4].removeAttribute("done")}}let currentStep=1;function setupViewListener(){for(let e=0;e<document.getElementById("allkits").children.length;e++){var t=document.getElementById("allkits").children[e];t.children[1].children[0].children[0].setAttribute("originalHTML",t.children[1].children[0].children[0].innerHTML),t.children[1].children[0].children[1].setAttribute("originalHTML",t.children[1].children[0].children[1].innerHTML),13<=t.children[1].children[0].children[0].innerHTML.length&&(t.children[1].children[0].children[0].innerHTML=t.children[1].children[0].children[0].innerHTML.substring(0,12)+"..."),32<=t.children[1].children[0].children[1].innerHTML.length&&(t.children[1].children[0].children[1].innerHTML=t.children[1].children[0].children[1].innerHTML.substring(0,32)+"...")}document.getElementById("kitviewswitcher").children[0].addEventListener("click",()=>{document.getElementById("kitviewswitcher").children[0].setAttribute("selected",""),document.getElementById("kitviewswitcher").children[1].removeAttribute("selected"),document.getElementById("allkits").removeAttribute("list"),document.getElementById("allkits").setAttribute("grid","");for(let e=0;e<document.getElementById("allkits").children.length;e++){var t=document.getElementById("allkits").children[e];t.children[1].children[0].children[0].setAttribute("originalHTML",t.children[1].children[0].children[0].innerHTML),t.children[1].children[0].children[1].setAttribute("originalHTML",t.children[1].children[0].children[1].innerHTML),13<=t.children[1].children[0].children[0].innerHTML.length&&(t.children[1].children[0].children[0].innerHTML=t.children[1].children[0].children[0].innerHTML.substring(0,12)+"..."),32<=t.children[1].children[0].children[1].innerHTML.length&&(t.children[1].children[0].children[1].innerHTML=t.children[1].children[0].children[1].innerHTML.substring(0,32)+"...")}}),document.getElementById("kitviewswitcher").children[1].addEventListener("click",()=>{document.getElementById("kitviewswitcher").children[1].setAttribute("selected",""),document.getElementById("kitviewswitcher").children[0].removeAttribute("selected"),document.getElementById("allkits").removeAttribute("grid"),document.getElementById("allkits").setAttribute("list","");for(let e=0;e<document.getElementById("allkits").children.length;e++){var t=document.getElementById("allkits").children[e];t.children[1].children[0].children[0].hasAttribute("originalHTML")&&t.children[1].children[0].children[1].hasAttribute("originalHTML")&&(t.children[1].children[0].children[0].innerHTML=t.children[1].children[0].children[0].getAttribute("originalHTML"),t.children[1].children[0].children[1].innerHTML=t.children[1].children[0].children[1].getAttribute("originalHTML"),t.children[1].children[0].children[0].removeAttribute("originalHTML"),t.children[1].children[0].children[1].removeAttribute("originalHTML"))}})}let selectedKit="",selectedKitName="";async function loadAndShowKits(l){return new Promise(async(e,t)=>{insertLoadingScreen("loadKits",document.getElementById("content").parentElement);let n=await getDocs(collection(db,"users",auth.currentUser.uid,"kits"));if(1==n.empty)document.getElementById("loadingKits").innerHTML='<i class="fa-light fa-circle-xmark"></i> No kits found.';else{document.getElementById("loadingKits").style.display="none";let t=0;n.forEach(e=>{let i=e.data(),r=e.id,d=document.getElementById("kitex").cloneNode(!0);d.id=r,d.children[0].children[0].src=i.cover,d.children[1].children[0].children[0].innerText=i.displayname,d.children[1].children[0].children[1].innerText=i.description,d.children[1].children[1].children[0].addEventListener("click",()=>{selectedKit=r,selectedKitName=i.displayname;var t=document.getElementById("allkits").children;for(let e=0;e<t.length;e++){var n=t[e];n.children[1].removeAttribute("selected"),n.children[1].children[1].children[0].removeAttribute("disabled")}d.children[1].setAttribute("selected",""),d.children[1].children[1].children[0].setAttribute("disabled",""),l()}),document.getElementById("allkits").appendChild(d),++t==n.size&&finishLoading("loadKits")})}e()})}async function initSwitchAnim(e,t){async function n(n){return new Promise(async(e,t)=>{setTimeout(()=>e(),1e3*n)})}document.getElementById("nexterror").setAttribute("hide",""),document.getElementById("next").setAttribute("disabled","");e=document.getElementById(e),t=document.getElementById(t);e.setAttribute("leave",""),await n(1.05),e.removeAttribute("leave"),e.setAttribute("not_active",""),t.removeAttribute("not_active"),t.setAttribute("enter",""),await n(1),t.removeAttribute("enter")}let __allGamemodes=await fetch("../../asset/gamemodes.json"),allGamemodes=await __allGamemodes.json();async function loadGamemodes(){await hasBluekidPlus();let n=await getDoc(doc(db,"users",auth.currentUser.uid));for(let t=0;t<allGamemodes.gamemodes.length;t++){let e=allGamemodes.gamemodes[t];var i=e.display,r=(e,e.cover),d=e.consideredNewUntil,l=e.id,c=(e,e.tags),s=null!=e.limitedAccess&&e.limitedAccess,m=null!=e.bluekidPlusOnly&&e.bluekidPlusOnly,o=document.getElementById("gamemodeex").cloneNode(!0),l=(o.id=l,o.children[0].children[0].src=r,o.children[1].children[0].children[0].children[0].innerText=i,new Date(d).getTime());(new Date).getTime()<l&&((r=document.createElement("div")).innerHTML="NEW",r.className="new",o.children[1].children[0].children[0].children[0].appendChild(r)),0==s&&(o.children[1].children[0].children[0].children[1].setAttribute("hide",""),1==m)&&(o.children[1].children[0].children[0].children[1].removeAttribute("hide"),o.children[1].children[0].children[0].children[1].innerHTML="This kit is for Bluekid+ users only.");for(let e=0;e<c.length;e++){var a=c[e],h=document.createElement("div");h.innerHTML=a,o.children[1].children[0].children[1].append(h)}o.children[1].children[1].children[0].addEventListener("click",()=>{kitDetails(t,e,n.data())}),document.getElementById("allgamemodes").appendChild(o)}}let selectedGamemodeIdx=-1;function progress(){switch(currentStep){case 1:BubbleSwitch.toOne(),initSwitchAnim("one","two");break;case 2:BubbleSwitch.toTwo(),initSwitchAnim("two","three"),document.getElementById("gamemodereview").innerHTML=allGamemodes.gamemodes[selectedGamemodeIdx].display,document.getElementById("kitreview").innerHTML=selectedKitName,document.getElementById("proceedToHosting").href=`./live.html?type=private&kit=${selectedKit}&gamemode=`+selectedGamemodeIdx;break;case 3:BubbleSwitch.toThree()}currentStep+=1}let useOriginalHTML=document.getElementById("usegamemode").innerHTML,listener=null;async function kitDetails(e,t,n){document.getElementById("usegamemode").removeEventListener("click",listener),document.getElementById("usegamemode").innerHTML=useOriginalHTML;var i=t.display,r=t.description,d=t.cover,l=null!=t.limitedAccess&&t.limitedAccess,c=null!=t.bluekidPlusOnly&&t.bluekidPlusOnly,s=t.releaseDate,m=t.ideaCreator,t=t.idealPlaytime;document.getElementById("gamemode_thumbnail").src=d,document.getElementById("gamemodedisplay").innerText=i,document.getElementById("gamemodedesc").innerText=r,document.getElementById("gamemodeReleaseDate").innerHTML=new Date(s).toLocaleDateString(),document.getElementById("gamemodeIdeaCreator").innerHTML=m,document.getElementById("gamemodePlaytime").innerHTML=t+" minutes.";let o=!0;l?(document.getElementById("usegamemode").innerHTML=useOriginalHTML+" [Test only]",n.limitedAccess||(document.getElementById("usegamemode").setAttribute("disabled",""),o=!1)):c&&(document.getElementById("usegamemode").className="puffy_button subscription_btn",await hasBluekidPlus()||(document.getElementById("usegamemode").setAttribute("disabled",""),o=!1)),listener=()=>{o&&(selectedGamemodeIdx=e,document.getElementById("gamemodedetails").close(),progress())},document.getElementById("usegamemode").addEventListener("click",listener),document.getElementById("gamemodedetails").showModal()}onAuthStateChanged(auth,async e=>{e||(alert("Not logged in."),location.href="../auth/login.html"),document.getElementById("hostingver").innerHTML=HOSTING_VERSION,document.getElementById("nexterror").removeAttribute("hide"),document.getElementById("nexterror").innerHTML="Select a kit to continue.",await loadAndShowKits(()=>{document.getElementById("nexterror").setAttribute("hide",""),document.getElementById("next").removeAttribute("disabled")}),setupViewListener(),loadGamemodes(),document.getElementById("next").addEventListener("click",()=>{progress()})});