import{onAuthStateChanged,auth,db,doc,getDoc,FirebaseHelper,ref,realtime,realtimeGet,HOSTING_VERSION,signInAnonymously,hasBluekidPlus,insertLoadingScreen,finishLoading}from"./util/firebase.js";function showJoinError(e){showNotification(2,e)}let isLoggedInFully=null;onAuthStateChanged(auth,async n=>{document.getElementById("hostingversion").innerHTML=HOSTING_VERSION;var t=new URLSearchParams(location.search),i=t.get("error");if(null!=i){switch(i){case"game_not_exist":showJoinError("Joinned game didn't exist.");break;case"game_deleted":showJoinError("Owner left.");break;case"kicked":showJoinError("Kicked.");break;case"inactive":showJoinError("Inactive for 5 minutes.");break;case"unknown":case"other":showJoinError("Something unknown happened. Please try again.")}window.history.pushState(null,"",window.location.pathname)}let e=null,o;if(null!=n?(isLoggedInFully=!n.isAnonymous)?(o=n.uid,console.log("Logged in: "+o),e=await FirebaseHelper.getUserData(o),document.getElementById("home").removeAttribute("hide"),document.getElementById("history").removeAttribute("hide"),document.getElementById("notloggedin").style.display="none"):(console.log("Anonymous"),document.getElementById("notloggedin").innerHTML=`<i class="fa-light fa-warning"></i> You aren't logged in.`,signInAnonymously(auth),document.getElementById("login").removeAttribute("hide")):(console.log("Not logged in"),document.getElementById("notloggedin").innerHTML=`<i class="fa-light fa-warning"></i> You aren't logged in.`,signInAnonymously(auth)),t.get("id")){var i=t.get("id"),n=(insertLoadingScreen("main"),ref(realtime,"games/"+i)),t=await realtimeGet(n);let e=!0;if(console.log(t),t.exists()&&null!=t.val()||(showJoinError("Game doesn't exist."),finishLoading("main"),e=!1),e&&t.val().settings.privacySettings.requireAccount&&!isLoggedInFully&&(showJoinError("This game requires an account. Make one <a href='./auth/signup.html'>here</a>."),e=!1,finishLoading("main")),e)return void location.replace("./hosting/client.html?id="+i)}isLoggedInFully&&showNotification(1,"Logged in as "+e.username),await hasBluekidPlus()&&((n=document.createElement("span")).innerHTML=" Plus",n.className="plusColor",document.getElementById("title").appendChild(n));let a=document.getElementById("join").innerHTML;document.getElementById("join").addEventListener("click",async()=>{function e(){document.getElementById("join").removeAttribute("disabled"),document.getElementById("join").innerHTML=a}document.getElementById("join").setAttribute("disabled",""),document.getElementById("join").innerHTML="Loading...";var n,t=document.getElementById("gid").value;null==(t=parseInt(t))||"NaN"==t.toString()?(showJoinError("Game ID but be a number."),e()):(n=ref(realtime,"games/"+t),n=await realtimeGet(n),console.log(n),n.exists()?n.val().settings.privacySettings.requireAccount&&!isLoggedInFully?(showJoinError("This game requires an account. Make one <a href='./auth/signup.html'>here</a>."),e()):(isLoggedInFully,location.href="./hosting/client.html?id="+t):(showJoinError("Game doesn't exist."),e()))})});